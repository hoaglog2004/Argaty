<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/admin}"
>
  <head>
    <title th:text="${isEdit} ? 'Sửa sản phẩm' : 'Thêm sản phẩm'">
      Sản phẩm
    </title>
  </head>

  <body>
    <div layout:fragment="content">
      <div class="admin-page-header">
        <h1
          class="admin-page-title"
          th:text="${isEdit} ?  'Sửa sản phẩm (Updated)' : 'Thêm sản phẩm mới (Updated)'"
        >
          Sản phẩm
        </h1>
        <div class="admin-page-actions">
          <a th:href="@{/admin/products}" class="btn btn-ghost">
            <i class="bx bx-arrow-back"></i> Quay lại
          </a>
        </div>
      </div>

      <form
        th:action="${isEdit} ? @{/admin/products/{id}/edit(id=${product.id})} : @{/admin/products/create}"
        method="post"
        th:object="${productRequest}"
      >
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px">
          <!-- Left Column -->
          <div>
            <!-- Basic Info -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-info-circle text-primary"></i> Thông tin cơ
                  bản
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Tên sản phẩm <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  th:field="*{name}"
                  class="form-control"
                  th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''"
                  placeholder="Nhập tên sản phẩm"
                  required
                />
                <div th:if="${#fields.hasErrors('name')}" class="form-error">
                  <i class="bx bx-error"></i> <span th:errors="*{name}"></span>
                </div>
              </div>

              <div class="admin-form-grid">
                <div class="form-group">
                  <label class="form-label">SKU</label>
                  <input
                    type="text"
                    th:field="*{sku}"
                    class="form-control"
                    placeholder="Mã sản phẩm (tự động nếu bỏ trống)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Slug</label>
                  <input
                    type="text"
                    th:field="*{slug}"
                    class="form-control"
                    placeholder="URL thân thiện (tự động)"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Mô tả ngắn</label>
                <textarea
                  th:field="*{shortDescription}"
                  class="form-control"
                  rows="2"
                  placeholder="Mô tả ngắn gọn về sản phẩm"
                ></textarea>
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Mô tả chi tiết</label>
                <textarea
                  th:field="*{description}"
                  class="form-control"
                  rows="6"
                  id="description"
                  placeholder="Mô tả chi tiết sản phẩm"
                ></textarea>
              </div>

              <div class="form-group mt-3">
                <label class="form-label">Thông số kỹ thuật</label>
                <textarea
                  th:field="*{specifications}"
                  class="form-control"
                  rows="4"
                  placeholder="Thông số kỹ thuật chi tiết..."
                ></textarea>
              </div>
            </div>

            <!-- SEO Metadata -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-search-alt text-primary"></i> SEO Metadata
                </h4>
              </div>
              <div class="form-group">
                <label class="form-label">Meta Title</label>
                <input
                  type="text"
                  th:field="*{metaTitle}"
                  class="form-control"
                  placeholder="Tiêu đề SEO"
                />
              </div>
              <div class="form-group mb-0">
                <label class="form-label">Meta Description</label>
                <textarea
                  th:field="*{metaDescription}"
                  class="form-control"
                  rows="3"
                  placeholder="Mô tả SEO"
                ></textarea>
              </div>
            </div>

            <!-- Images -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-image text-primary"></i> Hình ảnh
                </h4>
              </div>

              <div
                class="image-upload"
                onclick="document.getElementById('imageInput').click()"
              >
                <input
                  type="file"
                  id="imageInput"
                  multiple
                  accept="image/*"
                  data-max-files="10"
                  style="display: none"
                />
                <i class="bx bx-cloud-upload image-upload__icon"></i>
                <p class="image-upload__text">
                  Kéo thả hoặc click để tải ảnh lên
                </p>
                <p class="image-upload__hint">
                  JPG, PNG tối đa 5MB. Có thể chọn nhiều ảnh.
                </p>
              </div>

              <div class="image-preview-grid" id="imagePreview">
                <th:block th:if="${product != null && product.images != null}">
                  <div
                    th:each="img : ${product.images}"
                    class="image-preview-item"
                  >
                    <img th:src="${img.imageUrl}" />
                    <button
                      type="button"
                      class="image-preview-item__remove"
                      th:onclick="'removeExistingImage(' + ${img.id} + ', this)'"
                    >
                      <i class="bx bx-x"></i>
                    </button>
                    <input
                      type="hidden"
                      name="existingImageIds"
                      th:value="${img.id}"
                    />
                  </div>
                </th:block>
              </div>

              <!-- Uploaded image URLs for ProductRequest.imageUrls -->
              <div id="imageUrlsContainer" style="display: none"></div>
            </div>

            <!-- Variants -->
            <div class="admin-form-card">
              <div
                class="admin-form-card__header d-flex justify-between align-center"
              >
                <h4 class="admin-form-card__title mb-0">
                  <i class="bx bx-layer text-primary"></i> Biến thể sản phẩm
                </h4>
                <button
                  type="button"
                  class="btn btn-outline btn-sm"
                  onclick="addVariant()"
                >
                  <i class="bx bx-plus"></i> Thêm biến thể
                </button>
              </div>

              <div id="variantsContainer">
                <th:block
                  th:if="${product != null && product.variants != null}"
                >
                  <div
                    th:each="variant, stat : ${product.variants}"
                    class="variant-item card p-3 mb-3"
                    th:attr="data-variant-index=${stat.index}"
                  >
                    <div class="d-flex justify-between align-center mb-3">
                      <strong class="text-primary">
                        <i class="bx bx-cube"></i> Biến thể #<span
                          class="variant-index"
                          th:text="${stat.index + 1}"
                          >1</span
                        >
                      </strong>
                      <button
                        type="button"
                        class="btn btn-ghost btn-sm text-danger"
                        onclick="removeVariant(this)"
                      >
                        <i class="bx bx-trash"></i> Xóa
                      </button>
                    </div>
                    <input
                      type="hidden"
                      th:name="'variants[' + ${stat.index} + '].id'"
                      th:value="${variant.id}"
                    />
                    <div
                      class="admin-form-grid"
                      style="grid-template-columns: repeat(3, 1fr)"
                    >
                      <div class="form-group mb-3">
                        <label class="form-label"
                          >Tên biến thể
                          <span class="text-danger">*</span></label
                        >
                        <input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].name'"
                          th:value="${variant.name}"
                          class="form-control"
                          placeholder="VD: Đen 128GB, Size L"
                          required
                        />
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label">SKU biến thể</label>
                        <input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].sku'"
                          th:value="${variant.sku}"
                          class="form-control"
                          placeholder="Mã SKU riêng"
                        />
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label">Màu sắc</label>
                        <input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].color'"
                          th:value="${variant.color}"
                          class="form-control"
                          placeholder="VD: Đen, Trắng, Xanh"
                        />
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label">Mã màu</label>
                        <div class="d-flex gap-2">
                          <input
                            type="color"
                            th:name="'variants[' + ${stat.index} + '].colorCode'"
                            th:value="${variant.colorCode ?: '#000000'}"
                            class="form-control"
                            style="width: 50px; padding: 4px"
                          />
                          <input
                            type="text"
                            th:value="${variant.colorCode}"
                            class="form-control"
                            placeholder="#000000"
                            readonly
                          />
                        </div>
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label">Size</label>
                        <input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].size'"
                          th:value="${variant.size}"
                          class="form-control"
                          placeholder="VD: S, M, L, XL, 128GB"
                        />
                      </div>
                      <div class="form-group mb-3">
                        <label class="form-label">Giá thêm (+)</label>
                        <input
                          type="number"
                          th:name="'variants[' + ${stat.index} + '].additionalPrice'"
                          th:value="${variant.additionalPrice}"
                          class="form-control"
                          min="0"
                          step="1000"
                          placeholder="0"
                        />
                      </div>
                      <div class="form-group mb-0">
                        <label class="form-label"
                          >Số lượng <span class="text-danger">*</span></label
                        >
                        <input
                          type="number"
                          th:name="'variants[' + ${stat.index} + '].quantity'"
                          th:value="${variant.quantity}"
                          class="form-control"
                          min="0"
                          required
                        />
                      </div>
                    </div>
                    <!-- Variant Images -->
                    <div
                      class="mt-3 p-3"
                      style="background: var(--bg-void); border-radius: 8px"
                    >
                      <label class="form-label d-flex align-center gap-2">
                        <i class="bx bx-image"></i> Ảnh biến thể
                      </label>
                      <div
                        class="variant-images-preview d-flex gap-2 flex-wrap"
                        th:id="'variantImages-' + ${stat.index}"
                      >
                        <th:block th:if="${variant.images != null}">
                          <div
                            th:each="img : ${variant.images}"
                            class="variant-image-item"
                            style="position: relative"
                          >
                            <img
                              th:src="${img}"
                              style="
                                width: 60px;
                                height: 60px;
                                object-fit: cover;
                                border-radius: 6px;
                              "
                            />
                            <button
                              type="button"
                              class="btn btn-sm"
                              onclick="this.parentElement.remove()"
                              style="
                                position: absolute;
                                top: -8px;
                                right: -8px;
                                background: var(--danger);
                                color: white;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                padding: 0;
                              "
                            >
                              <i class="bx bx-x" style="font-size: 14px"></i>
                            </button>
                          </div>
                        </th:block>
                      </div>

                      <!-- Uploaded image URLs for ProductRequest.variants[i].imageUrls -->
                      <div
                        class="variant-image-urls"
                        th:id="'variantImageUrls-' + ${stat.index}"
                        style="display: none"
                      ></div>

                      <input
                        type="file"
                        th:id="'variantImageInput-' + ${stat.index}"
                        multiple
                        accept="image/*"
                        data-max-files="10"
                        class="form-control mt-2 variant-image-input"
                        style="font-size: 13px"
                      />
                    </div>
                  </div>
                </th:block>
              </div>

              <p
                th:if="${product == null || product.variants == null || product.variants.isEmpty()}"
                id="noVariantsText"
                class="text-muted text-center p-4"
                style="background: var(--bg-void); border-radius: 8px"
              >
                <i
                  class="bx bx-layer"
                  style="font-size: 32px; display: block; margin-bottom: 8px"
                ></i>
                Chưa có biến thể. Thêm biến thể nếu sản phẩm có nhiều tùy chọn
                (màu sắc, size, dung lượng...).
              </p>
            </div>
          </div>

          <!-- Right Column -->
          <div>
            <!-- Status & Category -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-cog text-primary"></i> Phân loại
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Danh mục <span class="text-danger">*</span></label
                >
                <select
                  th:field="*{categoryId}"
                  class="form-control form-select"
                  required
                >
                  <option value="">Chọn danh mục</option>
                  <option
                    th:each="cat : ${categories}"
                    th:value="${cat.id}"
                    th:text="${cat.name}"
                  ></option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Thương hiệu</label>
                <select th:field="*{brandId}" class="form-control form-select">
                  <option value="">Chọn thương hiệu</option>
                  <option
                    th:each="brand : ${brands}"
                    th:value="${brand.id}"
                    th:text="${brand.name}"
                  ></option>
                </select>
              </div>

              <div class="form-group mb-0">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isActive}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Hiển thị sản phẩm</span>
                </label>
              </div>
            </div>

            <!-- Pricing -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-dollar text-primary"></i> Giá & Kho
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Giá gốc <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  th:field="*{price}"
                  class="form-control"
                  min="0"
                  step="1000"
                  required
                  placeholder="VNĐ"
                />
              </div>

              <div class="form-group">
                <label class="form-label">Giá khuyến mãi</label>
                <input
                  type="number"
                  th:field="*{salePrice}"
                  class="form-control"
                  min="0"
                  step="1000"
                  placeholder="Để trống nếu không giảm giá"
                />
              </div>

              <div class="form-group">
                <label class="form-label">Ngày bắt đầu giảm giá</label>
                <input
                  type="datetime-local"
                  th:field="*{saleStartDate}"
                  class="form-control"
                />
              </div>

              <div class="form-group">
                <label class="form-label">Ngày kết thúc giảm giá</label>
                <input
                  type="datetime-local"
                  th:field="*{saleEndDate}"
                  class="form-control"
                />
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Số lượng trong kho</label>
                <input
                  type="number"
                  th:field="*{quantity}"
                  class="form-control"
                  min="0"
                  value="0"
                />
              </div>
            </div>

            <!-- Flags -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-star text-primary"></i> Đánh dấu
                </h4>
              </div>

              <div class="form-group mb-2">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isFeatured}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Sản phẩm nổi bật</span>
                </label>
              </div>
              <div class="form-group mb-2">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isBestSeller}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Bán chạy</span>
                </label>
              </div>
              <div class="form-group mb-0">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isNew}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Sản phẩm mới</span>
                </label>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-3">
              <button type="submit" class="btn btn-primary btn-block">
                <i class="bx bx-save"></i>
                <span th:text="${isEdit} ? 'Cập nhật' : 'Tạo sản phẩm'"
                  >Lưu</span
                >
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <th:block layout:fragment="scripts">
      <script>
        let variantIndex = /*[[${(product != null and product.variants != null) ? #lists.size(product.variants) : 0}]]*/ 0;

        function getCsrfField() {
          const inputs = Array.from(
            document.querySelectorAll('form input[type="hidden"][name][value]')
          );
          return (
            inputs.find((i) => i.name.toLowerCase().includes("csrf")) || null
          );
        }

        async function uploadMultipleFiles(files, directory) {
          const csrf = getCsrfField();
          const formData = new FormData();
          files.forEach((f) => formData.append("files", f));
          formData.append("directory", directory);
          if (csrf) {
            formData.append(csrf.name, csrf.value);
          }

          const res = await fetch("/api/files/upload-multiple", {
            method: "POST",
            body: formData,
            credentials: "same-origin",
          });

          const json = await res.json().catch(() => null);
          if (!res.ok || !json || json.success !== true) {
            throw new Error(json?.message || "Upload thất bại");
          }

          const urls = json?.data?.urls || [];
          if (!Array.isArray(urls) || urls.length === 0) {
            throw new Error("Upload thất bại: không nhận được URL");
          }

          return urls;
        }

        function setSubmitEnabled(enabled) {
          const btn = document.querySelector('button[type="submit"]');
          if (!btn) return;
          btn.disabled = !enabled;
        }

        let pendingUploads = 0;
        function beginUpload() {
          pendingUploads++;
          setSubmitEnabled(false);
        }

        function endUpload() {
          pendingUploads = Math.max(0, pendingUploads - 1);
          if (pendingUploads === 0) {
            setSubmitEnabled(true);
          }
        }

        function clearContainer(el) {
          if (!el) return;
          while (el.firstChild) el.removeChild(el.firstChild);
        }

        function appendHiddenInput(container, name, value) {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = name;
          input.value = value;
          container.appendChild(input);
        }

        function reindexVariants() {
          const items = Array.from(document.querySelectorAll(".variant-item"));
          items.forEach((item, newIndex) => {
            item.dataset.variantIndex = String(newIndex);

            const indexLabel = item.querySelector(".variant-index");
            if (indexLabel) indexLabel.textContent = String(newIndex + 1);

            // Update ids for preview/hidden containers and file input
            const preview = item.querySelector(".variant-images-preview");
            if (preview) preview.id = `variantImages-${newIndex}`;

            const urlsContainer = item.querySelector(".variant-image-urls");
            if (urlsContainer)
              urlsContainer.id = `variantImageUrls-${newIndex}`;

            const fileInput = item.querySelector(".variant-image-input");
            if (fileInput) fileInput.id = `variantImageInput-${newIndex}`;

            // Update all form field names variants[old].xxx -> variants[new].xxx
            item
              .querySelectorAll("input[name], select[name], textarea[name]")
              .forEach((field) => {
                field.name = field.name.replace(
                  /variants\[\d+\]/g,
                  `variants[${newIndex}]`
                );
              });

            // Update hidden inputs names for imageUrls if using indexed notation
            item
              .querySelectorAll('input[type="hidden"][name^="variants["]')
              .forEach((hidden) => {
                hidden.name = hidden.name.replace(
                  /variants\[\d+\]/g,
                  `variants[${newIndex}]`
                );
              });
          });

          // Keep variantIndex in sync for newly added variants
          variantIndex = items.length;
        }

        function addVariant() {
          document.getElementById("noVariantsText")?.remove();

          const container = document.getElementById("variantsContainer");
          const html = `
            <div class="variant-item card p-3 mb-3">
              <div class="d-flex justify-between align-center mb-3">
                <strong class="text-primary">
                  <i class='bx bx-cube'></i> Biến thể #<span class="variant-index">${
                    variantIndex + 1
                  }</span>
                </strong>
                <button type="button" class="btn btn-ghost btn-sm text-danger" onclick="removeVariant(this)">
                  <i class='bx bx-trash'></i> Xóa
                </button>
              </div>
              <div class="admin-form-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group mb-3">
                  <label class="form-label">Tên biến thể <span class="text-danger">*</span></label>
                  <input type="text" name="variants[${variantIndex}].name" class="form-control" placeholder="VD: Đen 128GB, Size L" required>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">SKU biến thể</label>
                  <input type="text" name="variants[${variantIndex}].sku" class="form-control" placeholder="Mã SKU riêng">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Màu sắc</label>
                  <input type="text" name="variants[${variantIndex}].color" class="form-control" placeholder="VD: Đen, Trắng, Xanh">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Mã màu</label>
                  <div class="d-flex gap-2">
                    <input type="color" name="variants[${variantIndex}].colorCode" value="#000000" class="form-control" style="width: 50px; padding: 4px;" onchange="this.nextElementSibling.value = this.value">
                    <input type="text" class="form-control" placeholder="#000000" value="#000000" readonly>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Size</label>
                  <input type="text" name="variants[${variantIndex}].size" class="form-control" placeholder="VD: S, M, L, XL, 128GB">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Giá thêm (+)</label>
                  <input type="number" name="variants[${variantIndex}].additionalPrice" class="form-control" min="0" step="1000" placeholder="0" value="0">
                </div>
                <div class="form-group mb-0">
                  <label class="form-label">Số lượng <span class="text-danger">*</span></label>
                  <input type="number" name="variants[${variantIndex}].quantity" class="form-control" min="0" value="0" required>
                </div>
              </div>
              <div class="mt-3 p-3" style="background: var(--bg-void); border-radius: 8px;">
                <label class="form-label d-flex align-center gap-2">
                  <i class='bx bx-image'></i> Ảnh biến thể
                </label>
                <div class="variant-images-preview d-flex gap-2 flex-wrap" id="variantImages-${variantIndex}"></div>
                <div class="variant-image-urls" id="variantImageUrls-${variantIndex}" style="display:none"></div>
                <input type="file" id="variantImageInput-${variantIndex}" multiple accept="image/*" data-max-files="10" class="form-control mt-2 variant-image-input" style="font-size: 13px;">
              </div>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", html);
          reindexVariants();
        }

        function removeVariant(btn) {
          btn.closest(".variant-item").remove();
          reindexVariants();
        }

        async function handleVariantImageSelect(input) {
          const item = input.closest(".variant-item");
          if (!item) return;

          const index = Number(item.dataset.variantIndex || "0");
          const preview = document.getElementById(`variantImages-${index}`);
          const urlsContainer = document.getElementById(
            `variantImageUrls-${index}`
          );
          if (!preview || !urlsContainer) return;

          const maxFiles = Number(input.dataset.maxFiles || "10");
          const files = Array.from(input.files || []);
          if (files.length === 0) return;

          if (files.length > maxFiles) {
            if (typeof showToast === "function") {
              showToast(
                "error",
                "Quá nhiều ảnh",
                `Tối đa ${maxFiles} ảnh mỗi biến thể.`
              );
            } else {
              alert(`Tối đa ${maxFiles} ảnh mỗi biến thể.`);
            }
            input.value = "";
            return;
          }

          beginUpload();
          try {
            const urls = await uploadMultipleFiles(files, "products");

            // Append previews + hidden url fields
            urls.forEach((url) => {
              const div = document.createElement("div");
              div.className = "variant-image-item";
              div.style.cssText = "position: relative;";
              div.innerHTML = `
                <img src="${url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                <button type="button" class="btn btn-sm" onclick="this.parentElement.remove()" style="position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; padding: 0;">
                  <i class='bx bx-x' style="font-size: 14px;"></i>
                </button>
              `;
              preview.appendChild(div);

              const currentCount = urlsContainer.querySelectorAll(
                'input[type="hidden"]'
              ).length;
              appendHiddenInput(
                urlsContainer,
                `variants[${index}].imageUrls[${currentCount}]`,
                url
              );
            });

            // reset so user can re-pick same file
            input.value = "";
          } catch (e) {
            if (typeof showToast === "function") {
              showToast(
                "error",
                "Upload thất bại",
                e?.message || "Không thể upload ảnh."
              );
            } else {
              alert(e?.message || "Không thể upload ảnh.");
            }
          } finally {
            endUpload();
          }
        }

        // Image preview for main images
        document
          .getElementById("imageInput")
          ?.addEventListener("change", async function () {
            const preview = document.getElementById("imagePreview");
            const urlsContainer = document.getElementById("imageUrlsContainer");
            if (!preview || !urlsContainer) return;

            const maxFiles = Number(this.dataset.maxFiles || "10");
            const files = Array.from(this.files || []);
            if (files.length === 0) return;

            if (files.length > maxFiles) {
              if (typeof showToast === "function") {
                showToast(
                  "error",
                  "Quá nhiều ảnh",
                  `Tối đa ${maxFiles} ảnh cho sản phẩm.`
                );
              } else {
                alert(`Tối đa ${maxFiles} ảnh cho sản phẩm.`);
              }
              this.value = "";
              return;
            }

            beginUpload();
            try {
              const urls = await uploadMultipleFiles(files, "products");
              urls.forEach((url) => {
                const div = document.createElement("div");
                div.className = "image-preview-item";
                div.innerHTML = `
                  <img src="${url}">
                  <button type="button" class="image-preview-item__remove" onclick="this.parentElement.remove()">
                    <i class='bx bx-x'></i>
                  </button>
                `;
                preview.appendChild(div);

                appendHiddenInput(urlsContainer, "imageUrls", url);
              });

              this.value = "";
            } catch (e) {
              if (typeof showToast === "function") {
                showToast(
                  "error",
                  "Upload thất bại",
                  e?.message || "Không thể upload ảnh."
                );
              } else {
                alert(e?.message || "Không thể upload ảnh.");
              }
            } finally {
              endUpload();
            }
          });

        // Variant image inputs (both existing and dynamically added)
        document.addEventListener("change", (e) => {
          const target = e.target;
          if (!(target instanceof HTMLInputElement)) return;
          if (target.classList.contains("variant-image-input")) {
            handleVariantImageSelect(target);
          }
        });

        // Ensure correct initial indices for edit mode
        reindexVariants();

        function removeExistingImage(id, btn) {
          btn.closest(".image-preview-item").remove();
        }
      </script>
    </th:block>
  </body>
</html>
