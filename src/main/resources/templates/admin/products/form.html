<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/admin}"
>
  <head>
    <title th:text="${isEdit} ? 'Sửa sản phẩm' : 'Thêm sản phẩm'">
      Sản phẩm
    </title>
  </head>

  <body>
    <div layout:fragment="content">
      <div class="admin-page-header">
        <h1
          class="admin-page-title"
          th:text="${isEdit} ?  'Sửa sản phẩm' : 'Thêm sản phẩm mới'"
        >
          Sản phẩm
        </h1>
        <div class="admin-page-actions">
          <a th:href="@{/admin/products}" class="btn btn-ghost">
            <i class="bx bx-arrow-back"></i> Quay lại
          </a>
        </div>
      </div>

      <form
        th:action="${isEdit} ? @{/admin/products/{id}/edit(id=${product.id})} : @{/admin/products/create}"
        method="post"
        th:object="${productRequest}"
        enctype="multipart/form-data"
      >
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px">
          <!-- Left Column -->
          <div>
            <!-- Basic Info -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-info-circle text-primary"></i> Thông tin cơ
                  bản
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Tên sản phẩm <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  th:field="*{name}"
                  class="form-control"
                  th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''"
                  placeholder="Nhập tên sản phẩm"
                  required
                />
                <div th:if="${#fields.hasErrors('name')}" class="form-error">
                  <i class="bx bx-error"></i> <span th:errors="*{name}"></span>
                </div>
              </div>

              <div class="admin-form-grid">
                <div class="form-group">
                  <label class="form-label">SKU</label>
                  <input
                    type="text"
                    th:field="*{sku}"
                    class="form-control"
                    placeholder="Mã sản phẩm (tự động nếu bỏ trống)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Slug</label>
                  <input
                    type="text"
                    th:field="*{slug}"
                    class="form-control"
                    placeholder="URL thân thiện (tự động)"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Mô tả ngắn</label>
                <textarea
                  th:field="*{shortDescription}"
                  class="form-control"
                  rows="2"
                  placeholder="Mô tả ngắn gọn về sản phẩm"
                ></textarea>
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Mô tả chi tiết</label>
                <textarea
                  th:field="*{description}"
                  class="form-control"
                  rows="6"
                  id="description"
                  placeholder="Mô tả chi tiết sản phẩm"
                ></textarea>
              </div>
            </div>

            <!-- Images -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-image text-primary"></i> Hình ảnh
                </h4>
              </div>

              <div
                class="image-upload"
                onclick="document.getElementById('imageInput').click()"
              >
                <input
                  type="file"
                  id="imageInput"
                  name="images"
                  multiple
                  accept="image/*"
                  style="display: none"
                />
                <i class="bx bx-cloud-upload image-upload__icon"></i>
                <p class="image-upload__text">
                  Kéo thả hoặc click để tải ảnh lên
                </p>
                <p class="image-upload__hint">
                  JPG, PNG tối đa 5MB. Có thể chọn nhiều ảnh.
                </p>
              </div>

              <div class="image-preview-grid" id="imagePreview">
                <div
                  th:if="${product != null}"
                  th:each="img : ${product.images}"
                  class="image-preview-item"
                >
                  <img th:src="${img.imageUrl}" />
                  <button
                    type="button"
                    class="image-preview-item__remove"
                    th:onclick="'removeExistingImage(' + ${img.id} + ', this)'"
                  >
                    <i class="bx bx-x"></i>
                  </button>
                  <input
                    type="hidden"
                    name="existingImageIds"
                    th:value="${img.id}"
                  />
                </div>
              </div>
            </div>

            <!-- Variants -->
            <div class="admin-form-card">
              <div
                class="admin-form-card__header d-flex justify-between align-center"
              >
                <h4 class="admin-form-card__title mb-0">
                  <i class="bx bx-layer text-primary"></i> Biến thể sản phẩm
                </h4>
                <button
                  type="button"
                  class="btn btn-outline btn-sm"
                  onclick="addVariant()"
                >
                  <i class="bx bx-plus"></i> Thêm biến thể
                </button>
              </div>

              <div id="variantsContainer">
                <div
                  th:if="${product != null && product.variants != null}"
                  th:each="variant, stat : ${product.variants}"
                  class="variant-item card p-3 mb-3"
                >
                  <div class="d-flex justify-between align-center mb-3">
                    <strong class="text-primary">
                      <i class="bx bx-cube"></i> Biến thể #<span
                        class="variant-index"
                        th:text="${stat.index + 1}"
                        >1</span
                      >
                    </strong>
                    <button
                      type="button"
                      class="btn btn-ghost btn-sm text-danger"
                      onclick="removeVariant(this)"
                    >
                      <i class="bx bx-trash"></i> Xóa
                    </button>
                  </div>
                  <input
                    type="hidden"
                    th:name="'variants[' + ${stat.index} + '].id'"
                    th:value="${variant.id}"
                  />
                  <div
                    class="admin-form-grid"
                    style="grid-template-columns: repeat(3, 1fr)"
                  >
                    <div class="form-group mb-3">
                      <label class="form-label"
                        >Tên biến thể <span class="text-danger">*</span></label
                      >
                      <input
                        type="text"
                        th:name="'variants[' + ${stat.index} + '].name'"
                        th:value="${variant.name}"
                        class="form-control"
                        placeholder="VD: Đen 128GB, Size L"
                        required
                      />
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">SKU biến thể</label>
                      <input
                        type="text"
                        th:name="'variants[' + ${stat.index} + '].sku'"
                        th:value="${variant.sku}"
                        class="form-control"
                        placeholder="Mã SKU riêng"
                      />
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Màu sắc</label>
                      <input
                        type="text"
                        th:name="'variants[' + ${stat.index} + '].color'"
                        th:value="${variant.color}"
                        class="form-control"
                        placeholder="VD: Đen, Trắng, Xanh"
                      />
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Mã màu</label>
                      <div class="d-flex gap-2">
                        <input
                          type="color"
                          th:name="'variants[' + ${stat.index} + '].colorCode'"
                          th:value="${variant.colorCode ?: '#000000'}"
                          class="form-control"
                          style="width: 50px; padding: 4px"
                        />
                        <input
                          type="text"
                          th:value="${variant.colorCode}"
                          class="form-control"
                          placeholder="#000000"
                          readonly
                        />
                      </div>
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Size</label>
                      <input
                        type="text"
                        th:name="'variants[' + ${stat.index} + '].size'"
                        th:value="${variant.size}"
                        class="form-control"
                        placeholder="VD: S, M, L, XL, 128GB"
                      />
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Giá thêm (+)</label>
                      <input
                        type="number"
                        th:name="'variants[' + ${stat.index} + '].additionalPrice'"
                        th:value="${variant.additionalPrice}"
                        class="form-control"
                        min="0"
                        step="1000"
                        placeholder="0"
                      />
                    </div>
                    <div class="form-group mb-0">
                      <label class="form-label"
                        >Số lượng <span class="text-danger">*</span></label
                      >
                      <input
                        type="number"
                        th:name="'variants[' + ${stat.index} + '].quantity'"
                        th:value="${variant.quantity}"
                        class="form-control"
                        min="0"
                        required
                      />
                    </div>
                  </div>
                  <!-- Variant Images -->
                  <div
                    class="mt-3 p-3"
                    style="background: var(--bg-void); border-radius: 8px"
                  >
                    <label class="form-label d-flex align-center gap-2">
                      <i class="bx bx-image"></i> Ảnh biến thể
                    </label>
                    <div
                      class="variant-images-preview d-flex gap-2 flex-wrap"
                      th:id="'variantImages-' + ${stat.index}"
                    >
                      <div
                        th:if="${variant.images != null}"
                        th:each="img : ${variant.images}"
                        class="variant-image-item"
                        style="position: relative"
                      >
                        <img
                          th:src="${img}"
                          style="
                            width: 60px;
                            height: 60px;
                            object-fit: cover;
                            border-radius: 6px;
                          "
                        />
                        <button
                          type="button"
                          class="btn btn-sm"
                          onclick="this.parentElement.remove()"
                          style="
                            position: absolute;
                            top: -8px;
                            right: -8px;
                            background: var(--danger);
                            color: white;
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            padding: 0;
                          "
                        >
                          <i class="bx bx-x" style="font-size: 14px"></i>
                        </button>
                      </div>
                    </div>
                    <input
                      type="file"
                      th:id="'variantImageInput-' + ${stat.index}"
                      th:name="'variantImages[' + ${stat.index} + ']'"
                      multiple
                      accept="image/*"
                      class="form-control mt-2"
                      style="font-size: 13px"
                    />
                  </div>
                </div>
              </div>

              <p
                th:if="${product == null || product.variants == null || product.variants.isEmpty()}"
                id="noVariantsText"
                class="text-muted text-center p-4"
                style="background: var(--bg-void); border-radius: 8px"
              >
                <i
                  class="bx bx-layer"
                  style="font-size: 32px; display: block; margin-bottom: 8px"
                ></i>
                Chưa có biến thể. Thêm biến thể nếu sản phẩm có nhiều tùy chọn
                (màu sắc, size, dung lượng...).
              </p>
            </div>
          </div>

          <!-- Right Column -->
          <div>
            <!-- Status & Category -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-cog text-primary"></i> Phân loại
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Danh mục <span class="text-danger">*</span></label
                >
                <select
                  th:field="*{categoryId}"
                  class="form-control form-select"
                  required
                >
                  <option value="">Chọn danh mục</option>
                  <option
                    th:each="cat : ${categories}"
                    th:value="${cat.id}"
                    th:text="${cat.name}"
                  ></option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Thương hiệu</label>
                <select th:field="*{brandId}" class="form-control form-select">
                  <option value="">Chọn thương hiệu</option>
                  <option
                    th:each="brand : ${brands}"
                    th:value="${brand.id}"
                    th:text="${brand.name}"
                  ></option>
                </select>
              </div>

              <div class="form-group mb-0">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isActive}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Hiển thị sản phẩm</span>
                </label>
              </div>
            </div>

            <!-- Pricing -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-dollar text-primary"></i> Giá & Kho
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Giá gốc <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  th:field="*{price}"
                  class="form-control"
                  min="0"
                  step="1000"
                  required
                  placeholder="VNĐ"
                />
              </div>

              <div class="form-group">
                <label class="form-label">Giá khuyến mãi</label>
                <input
                  type="number"
                  th:field="*{salePrice}"
                  class="form-control"
                  min="0"
                  step="1000"
                  placeholder="Để trống nếu không giảm giá"
                />
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Số lượng trong kho</label>
                <input
                  type="number"
                  th:field="*{quantity}"
                  class="form-control"
                  min="0"
                  value="0"
                />
              </div>
            </div>

            <!-- Flags -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-star text-primary"></i> Đánh dấu
                </h4>
              </div>

              <div class="form-group mb-2">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isFeatured}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Sản phẩm nổi bật</span>
                </label>
              </div>
              <div class="form-group mb-2">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isBestSeller}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Bán chạy</span>
                </label>
              </div>
              <div class="form-group mb-0">
                <label class="form-check">
                  <input
                    type="checkbox"
                    th:field="*{isNew}"
                    class="form-check-input"
                  />
                  <span class="form-check-label">Sản phẩm mới</span>
                </label>
              </div>
            </div>

            <!-- Sale Period -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-time text-primary"></i> Thời gian khuyến mãi
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label">Ngày bắt đầu</label>
                <input
                  type="datetime-local"
                  th:field="*{saleStartDate}"
                  class="form-control"
                  placeholder="Để trống nếu không giới hạn"
                />
                <small class="form-text text-muted">Để trống để áp dụng ngay lập tức</small>
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Ngày kết thúc</label>
                <input
                  type="datetime-local"
                  th:field="*{saleEndDate}"
                  class="form-control"
                  placeholder="Để trống nếu không giới hạn"
                />
                <small class="form-text text-muted">Để trống để không giới hạn thời gian</small>
              </div>
            </div>

            <!-- SEO -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-search text-primary"></i> SEO
                </h4>
              </div>

              <div class="form-group">
                <label class="form-label">Meta Title</label>
                <input
                  type="text"
                  th:field="*{metaTitle}"
                  class="form-control"
                  placeholder="Tiêu đề SEO (để trống sẽ dùng tên sản phẩm)"
                  maxlength="200"
                />
                <small class="form-text text-muted">Tối đa 200 ký tự</small>
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Meta Description</label>
                <textarea
                  th:field="*{metaDescription}"
                  class="form-control"
                  rows="2"
                  placeholder="Mô tả SEO (để trống sẽ dùng mô tả ngắn)"
                  maxlength="500"
                ></textarea>
                <small class="form-text text-muted">Tối đa 500 ký tự</small>
              </div>
            </div>

            <!-- Specifications -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-list-ul text-primary"></i> Thông số kỹ thuật
                </h4>
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Specifications</label>
                <textarea
                  th:field="*{specifications}"
                  class="form-control"
                  rows="4"
                  placeholder="Nhập thông số kỹ thuật (có thể dùng JSON hoặc text)"
                ></textarea>
                <small class="form-text text-muted">
                  Ví dụ: CPU: Intel Core i7, RAM: 16GB, Storage: 512GB SSD
                </small>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-3">
              <button type="submit" class="btn btn-primary btn-block">
                <i class="bx bx-save"></i>
                <span th:text="${isEdit} ? 'Cập nhật' : 'Tạo sản phẩm'"
                  >Lưu</span
                >
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <th:block layout:fragment="scripts">
      <script>
        let variantIndex = [[${product?.variants?.size() ?: 0}]];

        function addVariant() {
          document.getElementById("noVariantsText")?.remove();

          const container = document.getElementById("variantsContainer");
          const html = `
            <div class="variant-item card p-3 mb-3">
              <div class="d-flex justify-between align-center mb-3">
                <strong class="text-primary">
                  <i class='bx bx-cube'></i> Biến thể #<span class="variant-index">${variantIndex + 1}</span>
                </strong>
                <button type="button" class="btn btn-ghost btn-sm text-danger" onclick="removeVariant(this)">
                  <i class='bx bx-trash'></i> Xóa
                </button>
              </div>
              <div class="admin-form-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group mb-3">
                  <label class="form-label">Tên biến thể <span class="text-danger">*</span></label>
                  <input type="text" name="variants[${variantIndex}].name" class="form-control" placeholder="VD: Đen 128GB, Size L" required>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">SKU biến thể</label>
                  <input type="text" name="variants[${variantIndex}].sku" class="form-control" placeholder="Mã SKU riêng">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Màu sắc</label>
                  <input type="text" name="variants[${variantIndex}].color" class="form-control" placeholder="VD: Đen, Trắng, Xanh">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Mã màu</label>
                  <div class="d-flex gap-2">
                    <input type="color" name="variants[${variantIndex}].colorCode" value="#000000" class="form-control" style="width: 50px; padding: 4px;" onchange="this.nextElementSibling.value = this.value">
                    <input type="text" class="form-control" placeholder="#000000" value="#000000" readonly>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Size</label>
                  <input type="text" name="variants[${variantIndex}].size" class="form-control" placeholder="VD: S, M, L, XL, 128GB">
                </div>
                <div class="form-group mb-3">
                  <label class="form-label">Giá thêm (+)</label>
                  <input type="number" name="variants[${variantIndex}].additionalPrice" class="form-control" min="0" step="1000" placeholder="0" value="0">
                </div>
                <div class="form-group mb-0">
                  <label class="form-label">Số lượng <span class="text-danger">*</span></label>
                  <input type="number" name="variants[${variantIndex}].quantity" class="form-control" min="0" value="0" required>
                </div>
              </div>
              <div class="mt-3 p-3" style="background: var(--bg-void); border-radius: 8px;">
                <label class="form-label d-flex align-center gap-2">
                  <i class='bx bx-image'></i> Ảnh biến thể
                </label>
                <div class="variant-images-preview d-flex gap-2 flex-wrap" id="variantImages-${variantIndex}"></div>
                <input type="file" id="variantImageInput-${variantIndex}" name="variantImages[${variantIndex}]" multiple accept="image/*" class="form-control mt-2" style="font-size: 13px;" onchange="previewVariantImages(this, ${variantIndex})">
              </div>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", html);
          variantIndex++;
        }

        function removeVariant(btn) {
          btn.closest(".variant-item").remove();
          updateVariantIndices();
        }

        function updateVariantIndices() {
          document.querySelectorAll(".variant-index").forEach((el, i) => {
            el.textContent = i + 1;
          });
        }

        function previewVariantImages(input, index) {
          const preview = document.getElementById('variantImages-' + index);
          if (!preview) return;

          Array.from(input.files).forEach((file) => {
            if (!file.type.startsWith("image/")) return;

            const reader = new FileReader();
            reader.onload = function (e) {
              const div = document.createElement("div");
              div.className = "variant-image-item";
              div.style.cssText = "position: relative;";
              div.innerHTML = `
                <img src="${e.target.result}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                <button type="button" class="btn btn-sm" onclick="this.parentElement.remove()" style="position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; padding: 0;">
                  <i class='bx bx-x' style="font-size: 14px;"></i>
                </button>
              `;
              preview.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        }

        // Image preview for main images
        document
          .getElementById("imageInput")
          ?.addEventListener("change", function () {
            const preview = document.getElementById("imagePreview");

            Array.from(this.files).forEach((file) => {
              if (!file.type.startsWith("image/")) return;

              const reader = new FileReader();
              reader.onload = function (e) {
                const div = document.createElement("div");
                div.className = "image-preview-item";
                div.innerHTML = `
                  <img src="${e.target.result}">
                  <button type="button" class="image-preview-item__remove" onclick="this.parentElement.remove()">
                    <i class='bx bx-x'></i>
                  </button>
                `;
                preview.appendChild(div);
              };
              reader.readAsDataURL(file);
            });
          });

        function removeExistingImage(id, btn) {
          btn.closest(".image-preview-item").remove();
        }
      </script>
    </th:block>
  </body>
</html>
