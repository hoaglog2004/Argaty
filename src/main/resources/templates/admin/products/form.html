<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/admin}"
>
  <head>
    <title th:text="${isEdit} ? 'Sửa sản phẩm' : 'Thêm sản phẩm'">
      Sản phẩm
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css"
      rel="stylesheet"
    />

    <style>
      /* --- COSMIC DARK THEME --- */
      :root {
        --bg-card: #121212;
        --bg-input: #1e1e24;
        --border-color: #2a2a35;
        --text-main: #ffffff;
        --primary: #8b5cf6;
      }
      .spec-row .input-group-text {
        background-color: var(--bg-card);
        border-color: var(--border-color);
        color: #a1a1aa;
      }
      .spec-row .form-control {
        background-color: var(--bg-input);
        color: white;
        border-color: var(--border-color);
      }
      .spec-row .form-control:focus {
        border-color: var(--primary);
        box-shadow: none;
      }
      .preview-image-item {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        cursor: move;
        background: #000;
        transition: transform 0.2s;
      }
      .preview-image-item:hover {
        border-color: var(--primary);
      }
      .preview-image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .image-order-badge {
        position: absolute;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: bold;
        border-bottom-right-radius: 8px;
        z-index: 2;
      }
      .image-order-badge.is-main {
        background: var(--primary);
      }
      .preview-image-item .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        z-index: 2;
      }
      .admin-form-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
      }
      .admin-form-card__title {
        color: var(--text-main);
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }
      .form-control,
      .form-select {
        background-color: var(--bg-input) !important;
        border: 1px solid var(--border-color) !important;
        color: #fff !important;
        border-radius: 8px;
      }
      .form-label {
        color: #a1a1aa;
        font-size: 13px;
        margin-bottom: 6px;
      }
      .note-editor.note-frame {
        border: 1px solid #27272a !important;
        background-color: #121212 !important;
      }
      .note-editor .note-toolbar {
        background-color: #18181b !important;
        border-bottom: 1px solid #27272a !important;
        color: white;
      }
      .note-editor .note-editing-area .note-editable {
        background-color: #050505 !important;
        color: #ffffff !important;
      }
      .note-btn {
        background-color: #27272a !important;
        color: #a1a1aa !important;
        border: 1px solid #3f3f46 !important;
      }
      .variant-item {
        background: #18181b;
        border: 1px solid var(--border-color);
        border-radius: 10px;
      }
    </style>
  </head>

  <body>
    <div layout:fragment="content">
      <div
        class="admin-page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1
          class="admin-page-title text-white"
          th:text="${isEdit} ? 'CẬP NHẬT SẢN PHẨM' : 'THÊM SẢN PHẨM MỚI'"
        ></h1>
        <a th:href="@{/admin/products}" class="btn btn-outline-light"
          ><i class="bx bx-arrow-back"></i> Quay lại</a
        >
      </div>

      <!-- Ví dụ mẫu cho staff (áp dụng tương tự cho product nếu cần) -->
      <!--
      <form th:object="${staff}" method="post" enctype="multipart/form-data">
        <div>
          <label>Họ tên:</label>
          <input th:field="*{name}" type="text" />
        </div>
        <div>
          <label>Ngày sinh:</label>
          <input th:value="*{#dates.format(birthday, 'yyyy-MM-dd')}" name="birthday" type="date" />
        </div>
        <div>
          <label>Ảnh đại diện:</label>
          <input type="file" name="avatarFile" />
          <input type="hidden" th:field="*{avatar}" />
          <div>
            <img th:src="@{${staff.avatar}}" alt="Avatar" width="100"/>
          </div>
        </div>
        <button type="submit">Lưu</button>
      </form>
      -->
      <form
        th:action="${isEdit} ? @{/admin/products/{id}/edit(id=${product.id})} : @{/admin/products/create}"
        method="post"
        th:object="${productRequest}"
        enctype="multipart/form-data"
        id="productForm"
      >
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px">
          <div>
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">
                  <i class="bx bx-info-circle text-primary"></i> Thông tin cơ
                  bản
                </h4>
              </div>
              <div class="form-group mb-3">
                <label class="form-label"
                  >Tên sản phẩm <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  th:field="*{name}"
                  class="form-control"
                  required
                  placeholder="Nhập tên sản phẩm"
                />
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label class="form-label">SKU</label
                  ><input
                    type="text"
                    th:field="*{sku}"
                    class="form-control"
                    placeholder="Tự động"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Slug</label
                  ><input
                    type="text"
                    th:field="*{slug}"
                    class="form-control"
                    placeholder="Tự động"
                  />
                </div>
              </div>
              <div class="form-group mb-3">
                <label class="form-label">Mô tả ngắn</label>
                <textarea
                  th:field="*{shortDescription}"
                  class="form-control"
                  rows="2"
                  placeholder="Mô tả ngắn gọn..."
                ></textarea>
              </div>
              <div class="form-group mb-4">
                <label class="form-label">Mô tả chi tiết</label>
                <textarea
                  th:field="*{description}"
                  id="summernote"
                  class="form-control"
                ></textarea>
              </div>
              <div
                class="pt-3 border-top"
                style="border-color: var(--border-color) !important"
              >
                <label class="form-label text-primary fw-bold mb-3"
                  ><i class="bx bx-list-ul"></i> THÔNG SỐ KỸ THUẬT</label
                >
                <div
                  id="specs-builder"
                  class="d-flex flex-column gap-2 mb-2"
                ></div>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  onclick="addSpecRow()"
                >
                  <i class="bx bx-plus"></i> Thêm dòng thông số
                </button>
                <textarea
                  th:field="*{specifications}"
                  id="specifications-input"
                  class="d-none"
                ></textarea>
              </div>
            </div>

            <div class="admin-form-card mb-4">
              <div
                class="admin-form-card__header d-flex justify-content-between align-items-center mb-3"
              >
                <h4
                  class="admin-form-card__title mb-0"
                  style="border: none; padding-bottom: 0"
                >
                  <i class="bx bx-image text-primary"></i> Thư viện ảnh
                </h4>
                <span
                  class="badge bg-dark border border-secondary text-muted fw-normal"
                >
                  <i class="bx bx-move"></i> Kéo thả để sắp xếp
                </span>
              </div>

              <div
                class="image-upload mb-4 p-5 text-center rounded position-relative"
                style="
                  border: 2px dashed var(--border-color);
                  background: rgba(255, 255, 255, 0.02);
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
                onmouseover="
                  this.style.borderColor = 'var(--primary)';
                  this.style.background = 'rgba(139, 92, 246, 0.05)';
                "
                onmouseout="
                  this.style.borderColor = 'var(--border-color)';
                  this.style.background = 'rgba(255, 255, 255, 0.02)';
                "
                onclick="document.getElementById('imageInput').click()"
              >
                <input
                  type="file"
                  id="imageInput"
                  multiple
                  accept="image/*"
                  style="display: none"
                />
                <div
                  class="d-flex flex-column align-items-center justify-content-center"
                >
                  <div
                    class="mb-3 p-3 rounded-circle"
                    style="background: rgba(139, 92, 246, 0.1)"
                  >
                    <i
                      class="bx bx-cloud-upload text-primary"
                      style="font-size: 32px"
                    ></i>
                  </div>
                  <h6 class="text-white mb-1">Click để chọn ảnh</h6>
                  <p class="text-muted small mb-0">Hỗ trợ: JPG, PNG, WEBP</p>
                </div>
              </div>

              <div
                class="image-sortable-container d-flex flex-wrap gap-3"
                id="imagePreview"
                style="min-height: 50px"
              >
                <!-- Ảnh đã lưu trong DB (khi sửa) -->
                <th:block th:if="${product != null && product.images != null}">
                  <div
                    th:each="img : ${product.images}"
                    class="preview-image-item"
                  >
                    <span class="image-order-badge"></span>
                    <img th:src="${img.imageUrl}" />
                    <button
                      type="button"
                      class="remove-btn"
                      onclick="
                        this.parentElement.remove();
                        updateImageOrder();
                      "
                    >
                      <i class="bx bx-x"></i>
                    </button>
                    <input
                      type="hidden"
                      name="existingImageIds"
                      th:value="${img.id}"
                    />
                  </div>
                </th:block>
                <!-- Ảnh vừa upload (khi submit lỗi hoặc upload mới) -->
                <th:block th:if="${productRequest != null && productRequest.imageUrls != null}">
                  <div
                    th:each="url, stat : ${productRequest.imageUrls}"
                    class="preview-image-item"
                  >
                    <span class="image-order-badge"></span>
                    <img th:src="${url}" />
                    <button
                      type="button"
                      class="remove-btn"
                      onclick="
                        this.parentElement.remove();
                        updateImageOrder();
                      "
                    >
                      <i class="bx bx-x"></i>
                    </button>
                    <input
                      type="hidden"
                      name="imageUrls"
                      th:value="${url}" />
                  </div>
                </th:block>
              </div>
              <div id="imageUrlsContainer" style="display: none"></div>
            </div>

            <div class="admin-form-card">
              <div
                class="admin-form-card__header d-flex justify-between align-center"
              >
                <h4 class="admin-form-card__title mb-0">
                  <i class="bx bx-layer text-primary"></i> Biến thể
                </h4>
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  onclick="addVariant()"
                >
                  <i class="bx bx-plus"></i> Thêm biến thể
                </button>
              </div>
              <p class="text-muted mb-3" style="font-size: 13px">
                Thiết lập nhóm phân loại, nhập danh sách giá trị rồi tạo tổ hợp SKU tự động.
              </p>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label class="form-label">Nhóm phân loại 1</label>
                  <input
                    type="text"
                    th:field="*{tier1Name}"
                    id="tier1Name"
                    class="form-control"
                    placeholder="VD: Màu sắc"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nhóm phân loại 2 (tuỳ chọn)</label>
                  <input
                    type="text"
                    th:field="*{tier2Name}"
                    id="tier2Name"
                    class="form-control"
                    placeholder="VD: Loại switch"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Giá trị nhóm 1 (phân tách bằng dấu phẩy)</label>
                  <input
                    type="text"
                    id="tier1ValuesInput"
                    class="form-control"
                    placeholder="Đen, Trắng"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Giá trị nhóm 2 (tuỳ chọn)</label>
                  <input
                    type="text"
                    id="tier2ValuesInput"
                    class="form-control"
                    placeholder="Blue, Red"
                  />
                </div>
                <div class="col-12 d-flex gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-primary btn-sm"
                    onclick="generateVariantCombinations()"
                  >
                    <i class="bx bx-grid-alt"></i> Tạo tổ hợp
                  </button>
                </div>
              </div>
              <div id="variantsContainer">
                <th:block
                  th:if="${product != null && product.variants != null}"
                >
                  <div
                    th:each="variant, stat : ${product.variants}"
                    class="variant-item card p-3 mb-3"
                    th:attr="data-variant-index=${stat.index},data-tier1=${variant.color},data-tier2=${variant.size}"
                  >
                    <div class="d-flex justify-between align-center mb-3">
                      <strong class="text-primary"
                        ><i class="bx bx-cube"></i> Biến thể #<span
                          class="variant-index"
                          th:text="${stat.index + 1}"
                        ></span
                      ></strong>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm"
                        onclick="removeVariantItem(this)"
                      >
                        <i class="bx bx-trash"></i> Xóa
                      </button>
                    </div>
                    <input
                      type="hidden"
                      th:name="'variants[' + ${stat.index} + '].id'"
                      th:value="${variant.id}"
                    />
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label class="form-label"
                          >Tên hiển thị
                          <span class="text-danger">*</span></label
                        ><input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].name'"
                          th:value="${variant.name}"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">SKU</label
                        ><input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].sku'"
                          th:value="${variant.sku}"
                          class="form-control"
                        />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label"
                          >Số lượng <span class="text-danger">*</span></label
                        ><input
                          type="number"
                          th:name="'variants[' + ${stat.index} + '].quantity'"
                          th:value="${variant.quantity}"
                          class="form-control"
                          min="0"
                          required
                        />
                      </div>

                      <div class="col-md-6">
                        <label class="form-label tier1-label" style="font-size: 13px"
                          >PHÂN LOẠI 1</label
                        >
                        <input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].color'"
                          th:value="${variant.color}"
                          class="form-control tier1-value"
                          placeholder="VD: Kết nối, Loại switch"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label tier2-label" style="font-size: 13px"
                          >PHÂN LOẠI 2</label
                        >
                        <input
                          type="text"
                          th:name="'variants[' + ${stat.index} + '].size'"
                          th:value="${variant.size}"
                          class="form-control tier2-value"
                          placeholder="VD: Có dây, Không dây, Red Switch"
                        />
                      </div>
                      <div class="col-md-12">
                        <label class="form-label">Giá chênh lệch (+/-)</label
                        ><input
                          type="number"
                          th:name="'variants[' + ${stat.index} + '].additionalPrice'"
                          th:value="${variant.additionalPrice}"
                          class="form-control"
                          step="1000"
                        />
                      </div>
                    </div>
                    <div
                      class="mt-3 pt-3 border-top"
                      style="border-color: var(--border-color) !important"
                    >
                      <div
                        class="mt-3 pt-3 border-top"
                        style="border-color: var(--border-color) !important"
                      >
                        <label class="form-label mb-2"
                          ><i class="bx bx-image"></i> Ảnh biến thể</label
                        >
                        <div class="d-flex align-items-center gap-3">
                          <!-- Custom Upload Button -->
                          <label
                            class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                            style="
                              cursor: pointer;
                              height: 40px;
                              border-style: dashed;
                            "
                          >
                            <i class="bx bx-cloud-upload fs-5"></i> Chọn ảnh
                            <input
                              type="file"
                              th:id="'variantImageInput-' + ${stat.index}"
                              accept="image/*"
                              multiple
                              style="display: none"
                              onchange="handleVariantImageUpload(this)"
                            />
                          </label>

                          <!-- Preview Container -->
                          <div
                            class="variant-images-preview d-flex gap-2 flex-wrap"
                            th:id="'variantImages-' + ${stat.index}"
                          >
                            <th:block th:if="${variant.images != null}">
                              <div
                                th:each="img : ${variant.images}"
                                class="preview-image-item"
                                style="
                                  width: 40px;
                                  height: 40px;
                                  border-radius: 4px;
                                "
                              >
                                <img th:src="${img}" />
                                <button
                                  type="button"
                                  class="remove-btn"
                                  onclick="this.parentElement.remove()"
                                  style="
                                    width: 16px;
                                    height: 16px;
                                    font-size: 10px;
                                    top: -4px;
                                    right: -4px;
                                  "
                                >
                                  ×
                                </button>
                                <input
                                  type="hidden"
                                  th:name="'variants[' + ${stat.index} + '].imageUrls'"
                                  th:value="${img}"
                                />
                              </div>
                            </th:block>
                          </div>

                          <!-- Hidden URLs Container -->
                          <div
                            class="variant-image-urls"
                            th:id="'variantImageUrls-' + ${stat.index}"
                            style="display: none"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </th:block>
              </div>
              <p
                th:if="${product == null || product.variants == null || product.variants.isEmpty()}"
                id="noVariantsText"
                class="text-muted text-center p-4"
              >
                Chưa có biến thể.
              </p>
            </div>
          </div>

          <div>
            <!-- 1. Publish & Actions (Top Priority) -->
            <div
              class="admin-form-card mb-4"
              style="border-top: 4px solid var(--primary)"
            >
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">Hành động</h4>
              </div>
              <div class="d-grid gap-2 mb-3">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bx bx-save"></i>
                  <span th:text="${isEdit} ? 'Cập nhật' : 'Tạo mới'">Lưu</span>
                </button>
              </div>
              <hr style="border-color: var(--border-color)" />

              <div class="form-check form-switch mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  th:field="*{isActive}"
                />
                <label class="form-check-label text-white">Hiển thị</label>
              </div>
              <div class="form-check form-switch mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  th:field="*{isFeatured}"
                />
                <label class="form-check-label text-white text-warning"
                  >Sản phẩm nổi bật (Hot)</label
                >
              </div>
              <div class="form-check form-switch mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  th:field="*{isBestSeller}"
                />
                <label class="form-check-label text-white text-danger"
                  >Sản phẩm bán chạy</label
                >
              </div>
              <div class="form-check form-switch mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  th:field="*{isNew}"
                />
                <label class="form-check-label text-white text-info"
                  >Sản phẩm mới</label
                >
              </div>
            </div>

            <!-- 2. Price & Inventory -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">Giá & Kho</h4>
              </div>
              <div class="mb-3">
                <label class="form-label">Giá gốc</label>
                <input
                  type="number"
                  th:field="*{price}"
                  class="form-control"
                  required
                  placeholder="0"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Giá khuyến mãi</label>
                <input
                  type="number"
                  th:field="*{salePrice}"
                  class="form-control"
                  placeholder="0"
                />
              </div>
              <div class="mb-0">
                <label class="form-label">Tổng tồn kho</label>
                <input
                  type="number"
                  th:field="*{quantity}"
                  class="form-control"
                  value="0"
                />
              </div>
            </div>

            <!-- 3. Organization (Category/Brand) -->
            <div class="admin-form-card mb-4">
              <div class="admin-form-card__header">
                <h4 class="admin-form-card__title">Phân loại</h4>
              </div>
              <div class="mb-3">
                <label class="form-label">Danh mục</label>
                <select
                  th:field="*{categoryId}"
                  class="form-control form-select"
                  required
                >
                  <option value="">Chọn danh mục</option>
                  <option
                    th:each="cat : ${categories}"
                    th:value="${cat.id}"
                    th:text="${cat.name}"
                  ></option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Thương hiệu</label>
                <select th:field="*{brandId}" class="form-control form-select">
                  <option value="">Chọn thương hiệu</option>
                  <option
                    th:each="brand : ${brands}"
                    th:value="${brand.id}"
                    th:text="${brand.name}"
                  ></option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <th:block layout:fragment="scripts">
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script
        src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"
      ></script>

      <script th:inline="javascript">
        /*<![CDATA[*/
        const csrfToken = document.querySelector('input[name="_csrf"]').value;

        $(document).ready(function () {
          $("#summernote").summernote({
            placeholder: "Mô tả chi tiết...",
            tabsize: 2,
            height: 350,
            toolbar: [
              ["style", ["style"]],
              ["font", ["bold", "underline"]],
              ["para", ["ul", "ol"]],
              ["insert", ["link", "picture", "video"]],
              ["view", ["fullscreen", "codeview"]],
            ],
            callbacks: {
              onImageUpload: function (files) {
                uploadEditorImage(files[0], this);
              },
            },
          });
        });
        async function uploadEditorImage(file, editor) {
          const formData = new FormData();
          formData.append("files", file);
          formData.append("directory", "editor");
          try {
            const res = await fetch("/api/files/upload-multiple", {
              method: "POST",
              headers: { "X-CSRF-TOKEN": csrfToken },
              body: formData,
            });
            const data = await res.json();
            if (data.success)
              $(editor).summernote("insertImage", data.data.urls[0]);
          } catch (e) {}
        }

        const sortable = new Sortable(document.getElementById("imagePreview"), {
          animation: 150,
          ghostClass: "sortable-ghost",
          onEnd: function () {
            updateImageOrder();
          },
        });
        function updateImageOrder() {
          document
            .querySelectorAll("#imagePreview .preview-image-item")
            .forEach((item, index) => {
              const badge = item.querySelector(".image-order-badge");
              if (badge) {
                badge.textContent = index === 0 ? "Ảnh bìa" : index + 1;
                if (index === 0) badge.classList.add("is-main");
                else badge.classList.remove("is-main");
              }
            });
        }
        updateImageOrder();

        document
          .getElementById("imageInput")
          .addEventListener("change", async function () {
            const files = Array.from(this.files);
            if (files.length === 0) return;
            const formData = new FormData();
            files.forEach((f) => formData.append("files", f));
            formData.append("directory", "products");
            try {
              const res = await fetch("/api/files/upload-multiple", {
                method: "POST",
                headers: { "X-CSRF-TOKEN": csrfToken },
                body: formData,
              });
              const data = await res.json();
              if (data.success) {
                const c = document.getElementById("imagePreview");
                const uc = document.getElementById("imageUrlsContainer");
                data.data.urls.forEach((url) => {
                  const div = document.createElement("div");
                  div.className = "preview-image-item";
                  div.innerHTML = `<span class="image-order-badge"></span><img src="${url}"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); updateImageOrder();">×</button>`;
                  c.appendChild(div);
                  const i = document.createElement("input");
                  i.type = "hidden";
                  i.name = "imageUrls";
                  i.value = url;
                  uc.appendChild(i);
                });
                updateImageOrder();
              }
            } catch (e) {}
            this.value = "";
          });

        // SPECS LOGIC
        document.addEventListener("DOMContentLoaded", function () {
          const rawSpecs = document.getElementById(
            "specifications-input",
          ).value;
          if (rawSpecs) {
            rawSpecs.split("\n").forEach((line) => {
              if (line.includes(":")) {
                const p = line.split(":");
                addSpecRow(p[0].trim(), p.slice(1).join(":").trim());
              }
            });
          } else {
            addSpecRow();
          }
        });
        function addSpecRow(key = "", value = "") {
          const div = document.createElement("div");
          div.className = "input-group spec-row mb-2";
          div.innerHTML = `<input type="text" class="form-control spec-key" placeholder="Tên (VD: Pin)" value="${key}" oninput="syncSpecs()" />
                <span class="input-group-text">:</span><input type="text" class="form-control spec-value" placeholder="Giá trị" value="${value}" oninput="syncSpecs()" />
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove(); syncSpecs()">×</button>`;
          document.getElementById("specs-builder").appendChild(div);
        }
        function syncSpecs() {
          let res = [];
          document.querySelectorAll(".spec-row").forEach((r) => {
            const k = r.querySelector(".spec-key").value.trim();
            const v = r.querySelector(".spec-value").value.trim();
            if (k && v) res.push(`${k}: ${v}`);
          });
          document.getElementById("specifications-input").value =
            res.join("\n");
        }

        // VARIANT LOGIC
        let variantIndex = /*[[${(product != null and product.variants != null) ? #lists.size(product.variants) : 0}]]*/ 0;

        const normalizeOptionValues = (raw) =>
          (raw || "")
            .split(",")
            .map((value) => value.trim())
            .filter((value) => value.length > 0)
            .filter((value, index, arr) => arr.indexOf(value) === index);

        function removeVariantItem(btn) {
          btn.closest(".variant-item")?.remove();
          if (!document.querySelector("#variantsContainer .variant-item")) {
            const container = document.getElementById("variantsContainer");
            container.insertAdjacentHTML(
              "afterend",
              '<p id="noVariantsText" class="text-muted text-center p-4">Chưa có biến thể.</p>',
            );
          }
        }

        function syncVariantGroupLabels() {
          const tier1Name =
            document.getElementById("tier1Name")?.value?.trim() || "Phân loại 1";
          const tier2Name =
            document.getElementById("tier2Name")?.value?.trim() || "Phân loại 2";

          document
            .querySelectorAll(".variant-item .tier1-label")
            .forEach((label) => (label.textContent = tier1Name.toUpperCase()));
          document
            .querySelectorAll(".variant-item .tier2-label")
            .forEach((label) => (label.textContent = tier2Name.toUpperCase()));
        }

        function buildVariantRow({
          index,
          id = "",
          name = "",
          sku = "",
          quantity = 0,
          color = "",
          size = "",
          additionalPrice = "",
        }) {
          const tier1Label =
            document.getElementById("tier1Name")?.value?.trim() || "Phân loại 1";
          const tier2Label =
            document.getElementById("tier2Name")?.value?.trim() || "Phân loại 2";

          return `
                <div class="variant-item card p-3 mb-3" data-variant-index="${index}" data-tier1="${color}" data-tier2="${size}">
                    <div class="d-flex justify-between align-center mb-3">
                        <strong class="text-primary"><i class='bx bx-cube'></i> Biến thể #${index + 1}</strong>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeVariantItem(this)"><i class='bx bx-trash'></i></button>
                    </div>
                    <input type="hidden" name="variants[${index}].id" value="${id}" />
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Tên hiển thị <span class="text-danger">*</span></label>
                            <input type="text" name="variants[${index}].name" class="form-control" required value="${name}" placeholder="VD: Đen - Blue" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">SKU</label>
                            <input type="text" name="variants[${index}].sku" class="form-control" value="${sku}" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tồn kho <span class="text-danger">*</span></label>
                            <input type="number" name="variants[${index}].quantity" class="form-control" required value="${quantity || 0}" min="0" />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label tier1-label" style="font-size: 13px;">${tier1Label.toUpperCase()}</label>
                          <input type="text" name="variants[${index}].color" class="form-control tier1-value" value="${color}" placeholder="Giá trị nhóm 1" />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label tier2-label" style="font-size: 13px;">${tier2Label.toUpperCase()}</label>
                          <input type="text" name="variants[${index}].size" class="form-control tier2-value" value="${size}" placeholder="Giá trị nhóm 2" />
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Giá chênh lệch (+/-)</label>
                            <input type="number" name="variants[${index}].additionalPrice" class="form-control" value="${additionalPrice ?? ""}" placeholder="0" step="1000" />
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-top" style="border-color: var(--border-color)!important;">
                        <label class="form-label mb-2"><i class='bx bx-image'></i> Ảnh biến thể</label>
                        <div class="d-flex align-items-center gap-3">
                            <label class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2" style="cursor: pointer; height: 40px; border-style: dashed;">
                                <i class='bx bx-cloud-upload fs-5'></i> Chọn ảnh
                                <input type="file" accept="image/*" multiple style="display: none;" onchange="handleVariantImageUpload(this, ${index})" />
                            </label>
                            <div class="variant-images-preview d-flex gap-2 flex-wrap" id="variantImages-${index}"></div>
                            <div class="variant-image-urls" id="variantImageUrls-${index}" style="display:none"></div>
                        </div>
                    </div>
                </div>`;
        }

        function addVariant() {
          document.getElementById("noVariantsText")?.remove();
          const container = document.getElementById("variantsContainer");
          const html = buildVariantRow({ index: variantIndex });
          container.insertAdjacentHTML("beforeend", html);
          variantIndex++;
          syncVariantGroupLabels();
        }

        function generateVariantCombinations() {
          const tier1Values = normalizeOptionValues(
            document.getElementById("tier1ValuesInput")?.value,
          );
          const tier2Values = normalizeOptionValues(
            document.getElementById("tier2ValuesInput")?.value,
          );

          if (tier1Values.length === 0) {
            showToast("warning", "Thiếu dữ liệu", "Vui lòng nhập giá trị cho nhóm phân loại 1");
            return;
          }

          const container = document.getElementById("variantsContainer");
          const currentRows = Array.from(container.querySelectorAll(".variant-item"));
          const existingMap = new Map();

          currentRows.forEach((row) => {
            const currentTier1 =
              row.querySelector("input[name$='.color']")?.value?.trim() ||
              row.getAttribute("data-tier1") ||
              "";
            const currentTier2 =
              row.querySelector("input[name$='.size']")?.value?.trim() ||
              row.getAttribute("data-tier2") ||
              "";
            const key = `${currentTier1}||${currentTier2}`;
            existingMap.set(key, {
              id: row.querySelector("input[name$='.id']")?.value || "",
              name: row.querySelector("input[name$='.name']")?.value || "",
              sku: row.querySelector("input[name$='.sku']")?.value || "",
              quantity: row.querySelector("input[name$='.quantity']")?.value || 0,
              additionalPrice:
                row.querySelector("input[name$='.additionalPrice']")?.value || "",
            });
          });

          const combos = [];
          if (tier2Values.length > 0) {
            tier1Values.forEach((tier1) => {
              tier2Values.forEach((tier2) => combos.push({ tier1, tier2 }));
            });
          } else {
            tier1Values.forEach((tier1) => combos.push({ tier1, tier2: "" }));
          }

          container.innerHTML = "";
          document.getElementById("noVariantsText")?.remove();

          combos.forEach((combo, index) => {
            const key = `${combo.tier1}||${combo.tier2}`;
            const existed = existingMap.get(key) || {};
            const displayName = combo.tier2
              ? `${combo.tier1} - ${combo.tier2}`
              : combo.tier1;

            container.insertAdjacentHTML(
              "beforeend",
              buildVariantRow({
                index,
                id: existed.id || "",
                name: existed.name || displayName,
                sku: existed.sku || "",
                quantity: existed.quantity || 0,
                color: combo.tier1,
                size: combo.tier2,
                additionalPrice: existed.additionalPrice || "",
              }),
            );
          });

          variantIndex = combos.length;
          syncVariantGroupLabels();
        }

        function reindexVariantInputs() {
          const items = document.querySelectorAll("#variantsContainer .variant-item");
          items.forEach((item, index) => {
            item.setAttribute("data-variant-index", index);
            item.querySelectorAll("input[name^='variants[']").forEach((input) => {
              input.name = input.name.replace(/variants\[\d+\]/, `variants[${index}]`);
            });
            item
              .querySelectorAll("input[type='file'][onchange*='handleVariantImageUpload']")
              .forEach(
                (input) =>
                  (input.setAttribute(
                    "onchange",
                    `handleVariantImageUpload(this, ${index})`,
                  )),
              );
            const preview = item.querySelector(".variant-images-preview");
            if (preview) preview.id = `variantImages-${index}`;
            const hiddenWrap = item.querySelector(".variant-image-urls");
            if (hiddenWrap) hiddenWrap.id = `variantImageUrls-${index}`;
          });
          variantIndex = items.length;
        }

        document.addEventListener("DOMContentLoaded", () => {
          syncVariantGroupLabels();
          document.getElementById("tier1Name")?.addEventListener("input", syncVariantGroupLabels);
          document.getElementById("tier2Name")?.addEventListener("input", syncVariantGroupLabels);
          document
            .querySelector("form")
            ?.addEventListener("submit", () => reindexVariantInputs());
        });

        async function handleVariantImageUpload(input, index) {
          if (index === undefined) {
            const item = input.closest(".variant-item");
            if (item) index = item.getAttribute("data-variant-index");
          }
          const files = Array.from(input.files);
          if (files.length === 0) return;
          const previewContainer = document.getElementById(
            `variantImages-${index}`,
          );
          const loading = document.createElement("span");
          loading.className = "text-muted text-xs";
          loading.textContent = "Đang tải...";
          previewContainer.appendChild(loading);

          const formData = new FormData();
          files.forEach((file) => formData.append("files", file));
          formData.append("directory", "variants");

          try {
            const res = await fetch("/api/files/upload-multiple", {
              method: "POST",
              headers: { "X-CSRF-TOKEN": csrfToken },
              body: formData,
            });
            const data = await res.json();

            if (data.success && data.data.urls.length > 0) {
              data.data.urls.forEach((url) => {
                const imgDiv = document.createElement("div");
                imgDiv.style.cssText =
                  "position:relative; width:60px; height:60px; border-radius:6px; overflow:hidden; border:1px solid #444;";
                imgDiv.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;" /><button type="button" onclick="this.parentElement.remove();" style="position:absolute;top:0;right:0;background:red;color:white;width:20px;height:20px;border:none;cursor:pointer;">×</button><input type="hidden" name="variants[${index}].imageUrls" value="${url}" />`;
                previewContainer.appendChild(imgDiv);
              });
            }
          } catch (e) {
            alert("Lỗi");
          } finally {
            loading.remove();
          }
          input.value = "";
        }
        /*]]>*/
      </script>
    </th:block>
  </body>
</html>
