<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/admin}"
>
  <head>
    <title th:text="'Đơn hàng ' + ${order.orderCode}">Chi tiết đơn hàng</title>
  </head>

  <body>
    <div layout:fragment="content" th:fragment="order-detail-content">
      <div class="admin-page-header">
        <div>
          <h1 class="admin-page-title">
            Đơn hàng
            <span class="text-cyan" th:text="${order.orderCode}"
              >ARG123456</span
            >
          </h1>
          <p class="text-muted mb-0">
            Đặt ngày
            <span
              th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"
              >01/01/2024</span
            >
          </p>
        </div>
        <div class="admin-page-actions">
          <button class="btn btn-outline" onclick="window.print()">
            <i class="bx bx-printer"></i> In đơn
          </button>
          <a th:href="@{/admin/orders}" class="btn btn-ghost">
            <i class="bx bx-arrow-back"></i> Quay lại
          </a>
        </div>
      </div>

      <div class="order-detail-grid">
        <div>
          <div class="order-info-card">
            <h4 class="order-info-card__title">
              <i class="bx bx-refresh"></i> Cập nhật trạng thái
            </h4>

            <div class="d-flex align-center gap-3 mb-3">
              <span class="text-muted">Trạng thái hiện tại:</span>
              <span
                class="status-badge status-badge--lg"
                th:classappend="'status-badge--' + ${order.status.name().toLowerCase()}"
                th:text="${order.statusDisplayName}"
                >Trạng thái</span
              >
            </div>

            <form
              onsubmit="updateOrderStatus(event, this, [[${order.id}]])"
              th:action="@{/admin/orders/{id}/status(id=${order.id})}"
              method="post"
              class="d-flex gap-3"
            >
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <select
                name="status"
                class="form-control form-select"
                style="flex: 1"
              >
                <option
                  value="PENDING"
                  th:selected="${order.status.name() == 'PENDING'}"
                >
                  Chờ xác nhận
                </option>
                <option
                  value="CONFIRMED"
                  th:selected="${order.status.name() == 'CONFIRMED'}"
                >
                  Đã xác nhận
                </option>
                <option
                  value="SHIPPING"
                  th:selected="${order.status.name() == 'SHIPPING'}"
                >
                  Đang giao hàng
                </option>
                <option
                  value="DELIVERED"
                  th:selected="${order.status.name() == 'DELIVERED'}"
                >
                  Đã giao hàng
                </option>
                <option
                  value="COMPLETED"
                  th:selected="${order.status.name() == 'COMPLETED'}"
                >
                  Hoàn thành
                </option>
                <option
                  value="CANCELLED"
                  th:selected="${order.status.name() == 'CANCELLED'}"
                >
                  Hủy đơn
                </option>
              </select>
              <button type="submit" class="btn btn-primary">
                <span
                  class="spinner-border spinner-border-sm d-none"
                  role="status"
                  aria-hidden="true"
                ></span>
                <span class="btn-text">Cập nhật</span>
              </button>
            </form>
          </div>

          <div class="order-info-card">
            <h4 class="order-info-card__title">
              <i class="bx bx-package"></i> Sản phẩm đặt hàng
            </h4>

            <div
              th:each="item : ${order.items}"
              class="d-flex gap-3 p-3"
              style="border-bottom: 1px solid var(--border-color)"
            >
              <div
                style="
                  width: 70px;
                  height: 70px;
                  border-radius: 8px;
                  overflow: hidden;
                  flex-shrink: 0;
                "
              >
                <img
                  th:src="${item.productImage}"
                  style="width: 100%; height: 100%; object-fit: cover"
                />
              </div>
              <div style="flex: 1">
                <p class="mb-1" th:text="${item.productName}">Sản phẩm</p>
                <p class="text-muted mb-0" style="font-size: 13px">
                  <span
                    th:if="${item.variantName}"
                    th:text="${item.variantName} + ' | '"
                  ></span>
                  <span
                    th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                    >0 ₫</span
                  >
                  x <span th:text="${item.quantity}">1</span>
                </p>
              </div>
              <div class="text-right">
                <strong
                  class="text-cyan"
                  th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >0 ₫</strong
                >
              </div>
            </div>

            <div class="p-3">
              <div class="d-flex justify-between mb-2">
                <span class="text-muted">Tạm tính:</span>
                <span
                  th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >0 ₫</span
                >
              </div>
              <div class="d-flex justify-between mb-2">
                <span class="text-muted">Phí ship:</span>
                <span
                  th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >0 ₫</span
                >
              </div>
              <div
                th:if="${order.discountAmount != null && order.discountAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                class="d-flex justify-between mb-2"
              >
                <span class="text-muted">Giảm giá:</span>
                <span
                  class="text-success"
                  th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >0 ₫</span
                >
              </div>
              <div
                class="d-flex justify-between pt-3"
                style="border-top: 1px solid var(--border-color)"
              >
                <strong>Tổng cộng:</strong>
                <strong
                  class="text-cyan"
                  style="font-size: 20px"
                  th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >0 ₫</strong
                >
              </div>
            </div>
          </div>

          <div class="order-info-card">
            <h4 class="order-info-card__title">
              <i class="bx bx-history"></i> Lịch sử đơn hàng
            </h4>
            <div class="timeline-list">
              <div
                th:each="history : ${order.histories}"
                class="d-flex gap-3 mb-3"
              >
                <div
                  style="
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: var(--primary);
                    margin-top: 6px;
                  "
                ></div>
                <div>
                  <p class="mb-0" th:text="${history.description}">Mô tả</p>
                  <small
                    class="text-muted"
                    th:text="${#temporals.format(history.createdAt, 'dd/MM/yyyy HH:mm')}"
                    >01/01/2024</small
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="order-info-card">
            <h4 class="order-info-card__title">
              <i class="bx bx-user"></i> Thông tin khách hàng
            </h4>
            <div class="order-info-row">
              <span class="order-info-row__label">Họ tên:</span>
              <span
                class="order-info-row__value"
                th:text="${order.receiverName}"
                >Tên</span
              >
            </div>
            <div class="order-info-row">
              <span class="order-info-row__label">SĐT:</span>
              <span
                class="order-info-row__value text-cyan"
                th:text="${order.receiverPhone}"
                >SĐT</span
              >
            </div>
            <div class="order-info-row" th:if="${order.receiverEmail}">
              <span class="order-info-row__label">Email:</span>
              <span
                class="order-info-row__value"
                th:text="${order.receiverEmail}"
                >Email</span
              >
            </div>
          </div>

          <div class="order-info-card">
            <h4 class="order-info-card__title">
              <i class="bx bx-map"></i> Địa chỉ giao hàng
            </h4>
            <p
              class="text-secondary mb-0"
              style="line-height: 1.8"
              th:text="${order.fullAddress}"
            >
              Địa chỉ
            </p>
          </div>

          <div class="order-info-card">
            <h4 class="order-info-card__title">
              <i class="bx bx-credit-card"></i> Thanh toán
            </h4>
            <div class="order-info-row">
              <span class="order-info-row__label">Phương thức: </span>
              <span
                class="order-info-row__value"
                th:text="${order.paymentMethodDisplayName}"
                >COD</span
              >
            </div>
            <div class="order-info-row">
              <span class="order-info-row__label">Trạng thái:</span>
              <span th:if="${order.isPaid}" class="text-success"
                ><i class="bx bx-check-circle"></i> Đã thanh toán</span
              >
              <span th:unless="${order.isPaid}" class="text-warning"
                ><i class="bx bx-time"></i> Chưa thanh toán</span
              >
            </div>
            <div class="order-info-row" th:if="${order.paidAt}">
              <span class="order-info-row__label">Ngày TT:</span>
              <span
                class="order-info-row__value"
                th:text="${#temporals.format(order.paidAt, 'dd/MM/yyyy HH:mm')}"
                >01/01/2024</span
              >
            </div>

            <form
              th:unless="${order.isPaid}"
              th:action="@{/admin/orders/{id}/mark-paid(id=${order.id})}"
              method="post"
              class="mt-3"
            >
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <button type="submit" class="btn btn-outline btn-sm btn-block">
                <i class="bx bx-check"></i> Đánh dấu đã thanh toán
              </button>
            </form>
          </div>

          <div class="order-info-card" th:if="${order.note}">
            <h4 class="order-info-card__title">
              <i class="bx bx-note"></i> Ghi chú
            </h4>
            <p class="text-secondary mb-0" th:text="${order.note}">Ghi chú</p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
