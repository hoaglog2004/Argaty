<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/main}"
>
  <head>
    <title th:text="'Đơn hàng ' + ${order.orderCode}">Chi tiết đơn hàng</title>
  </head>

  <body>
    <main layout:fragment="content">
      <div class="profile-page">
        <div class="container">
          <nav class="breadcrumb">
            <div class="breadcrumb__item">
              <a th:href="@{/}"><i class="bx bx-home"></i> Trang chủ</a>
            </div>
            <span class="breadcrumb__separator"
              ><i class="bx bx-chevron-right"></i
            ></span>
            <div class="breadcrumb__item">
              <a th:href="@{/profile}">Tài khoản</a>
            </div>
            <span class="breadcrumb__separator"
              ><i class="bx bx-chevron-right"></i
            ></span>
            <div class="breadcrumb__item">
              <a th:href="@{/profile/orders}">Đơn hàng</a>
            </div>
            <span class="breadcrumb__separator"
              ><i class="bx bx-chevron-right"></i
            ></span>
            <div class="breadcrumb__item" th:text="${order.orderCode}">
              ARG123456
            </div>
          </nav>

          <div class="profile-layout">
            <!-- Sidebar -->
            <th:block th:replace="~{user/profile/overview :: aside}"></th:block>

            <!-- Content -->
            <div class="profile-content">
              <div class="profile-content__header">
                <div>
                  <h2 class="profile-content__title mb-1">
                    Đơn hàng
                    <span class="text-cyan" th:text="${order.orderCode}"
                      >ARG123456</span
                    >
                  </h2>
                  <p class="text-muted mb-0" style="font-size: 14px">
                    Đặt ngày
                    <span
                      th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"
                      >01/01/2024</span
                    >
                  </p>
                </div>
                <span
                  class="status-badge status-badge--lg"
                  th:classappend="'status-badge--' + ${order.status.name().toLowerCase()}"
                  th:text="${order.statusDisplayName}"
                  >Trạng thái</span
                >
              </div>

              <!-- Order Timeline -->
              <div class="card p-4 mb-4">
                <h4 class="mb-4">
                  <i class="bx bx-time text-primary"></i> Trạng thái đơn hàng
                </h4>
                <div
                  class="timeline"
                  style="
                    display: flex;
                    justify-content: space-between;
                    position: relative;
                  "
                >
                  <!-- Timeline Track -->
                  <div
                    style="
                      position: absolute;
                      top: 20px;
                      left: 40px;
                      right: 40px;
                      height: 3px;
                      background: var(--border-color);
                    "
                  ></div>
                  <div
                    class="timeline-progress"
                    style="
                      position: absolute;
                      top: 20px;
                      left: 40px;
                      height: 3px;
                      background: var(--gradient-aurora);
                      transition: width 0.3s;
                    "
                    th:style="'width: ' + ${order.status.name() == 'PENDING' ? '0%' : (order.status.name() == 'CONFIRMED' ? '20%' : (order.status.name() == 'SHIPPING' ? '40%' : (order.status.name() == 'DELIVERED' ? '60%' : (order.status.name() == 'COMPLETED' ? '80%' : '0%'))))}"
                  ></div>

                  <!-- Steps -->
                  <div
                    class="timeline-step text-center"
                    style="position: relative; z-index: 1"
                  >
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 8px;
                      "
                      th:classappend="${order.createdAt != null} ? 'bg-success' :  'bg-muted'"
                      th:style="${order.createdAt != null} ? 'background: var(--success);' : 'background: var(--bg-void); border:  2px solid var(--border-color);'"
                    >
                      <i class="bx bx-cart" style="color: #fff"></i>
                    </div>
                    <p class="mb-0" style="font-size: 12px">Đặt hàng</p>
                    <p
                      class="text-muted"
                      style="font-size: 11px"
                      th:if="${order.createdAt}"
                      th:text="${#temporals.format(order.createdAt, 'dd/MM HH:mm')}"
                    ></p>
                  </div>

                  <div
                    class="timeline-step text-center"
                    style="position: relative; z-index: 1"
                  >
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 8px;
                      "
                      th:style="${order.confirmedAt != null} ? 'background: var(--success);' : 'background: var(--bg-void); border: 2px solid var(--border-color);'"
                    >
                      <i
                        class="bx bx-check"
                        th:style="${order.confirmedAt != null} ? 'color: #fff;' : 'color: var(--text-muted);'"
                      ></i>
                    </div>
                    <p class="mb-0" style="font-size: 12px">Xác nhận</p>
                    <p
                      class="text-muted"
                      style="font-size: 11px"
                      th:if="${order.confirmedAt}"
                      th:text="${#temporals.format(order.confirmedAt, 'dd/MM HH:mm')}"
                    ></p>
                  </div>

                  <div
                    class="timeline-step text-center"
                    style="position: relative; z-index: 1"
                  >
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 8px;
                      "
                      th:style="${order.shippedAt != null} ? 'background: var(--success);' : 'background: var(--bg-void); border: 2px solid var(--border-color);'"
                    >
                      <i
                        class="bx bx-car"
                        th:style="${order.shippedAt != null} ? 'color: #fff;' : 'color: var(--text-muted);'"
                      ></i>
                    </div>
                    <p class="mb-0" style="font-size: 12px">Đang giao</p>
                    <p
                      class="text-muted"
                      style="font-size: 11px"
                      th:if="${order.shippedAt}"
                      th:text="${#temporals.format(order.shippedAt, 'dd/MM HH: mm')}"
                    ></p>
                  </div>

                  <div
                    class="timeline-step text-center"
                    style="position: relative; z-index: 1"
                  >
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 8px;
                      "
                      th:style="${order.deliveredAt != null} ? 'background: var(--success);' : 'background: var(--bg-void); border: 2px solid var(--border-color);'"
                    >
                      <i
                        class="bx bx-home"
                        th:style="${order.deliveredAt != null} ? 'color: #fff;' : 'color: var(--text-muted);'"
                      ></i>
                    </div>
                    <p class="mb-0" style="font-size: 12px">Đã giao</p>
                    <p
                      class="text-muted"
                      style="font-size: 11px"
                      th:if="${order.deliveredAt}"
                      th:text="${#temporals.format(order.deliveredAt, 'dd/MM HH:mm')}"
                    ></p>
                  </div>

                  <div
                    class="timeline-step text-center"
                    style="position: relative; z-index: 1"
                  >
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 8px;
                      "
                      th:style="${order.completedAt != null} ? 'background: var(--success);' : 'background: var(--bg-void); border: 2px solid var(--border-color);'"
                    >
                      <i
                        class="bx bx-check-double"
                        th:style="${order.completedAt != null} ? 'color: #fff;' : 'color: var(--text-muted);'"
                      ></i>
                    </div>
                    <p class="mb-0" style="font-size: 12px">Hoàn thành</p>
                    <p
                      class="text-muted"
                      style="font-size: 11px"
                      th:if="${order.completedAt}"
                      th:text="${#temporals.format(order.completedAt, 'dd/MM HH:mm')}"
                    ></p>
                  </div>
                </div>
              </div>

              <div
                style="
                  display: grid;
                  grid-template-columns: 1.5fr 1fr;
                  gap: 24px;
                "
              >
                <!-- Order Items -->
                <div class="card">
                  <div class="card-header">
                    <h4 class="mb-0">
                      <i class="bx bx-package text-primary"></i> Sản phẩm
                    </h4>
                  </div>
                  <div class="card-body p-0">
                    <div
                      th:each="item : ${order.items}"
                      class="d-flex gap-4 p-4"
                      style="border-bottom: 1px solid var(--border-color)"
                    >
                      <a
                        th:href="@{/products/{slug}(slug=${item.productSlug})}"
                        style="
                          width: 80px;
                          height: 80px;
                          border-radius: 8px;
                          overflow: hidden;
                          flex-shrink: 0;
                        "
                      >
                        <img
                          th:src="${item.productImage}"
                          style="width: 100%; height: 100%; object-fit: cover"
                        />
                      </a>
                      <div style="flex: 1">
                        <a
                          th:href="@{/products/{slug}(slug=${item.productSlug})}"
                          class="mb-1 d-block"
                          th:text="${item.productName}"
                          >Sản phẩm</a
                        >
                        <p class="text-muted mb-0" style="font-size: 13px">
                          <span
                            th:if="${item.variantName}"
                            th:text="${item.variantName} + ' | '"
                          ></span>
                          <span
                            th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                            >0 ₫</span
                          >
                          x <span th:text="${item.quantity}">1</span>
                        </p>

                        <!-- Review Button -->
                        <button
                          th:if="${order.status.name() == 'COMPLETED' && ! item.isReviewed}"
                          class="btn btn-ghost btn-sm mt-2"
                          th:onclick="'openReviewModal(' + ${item.productId} + ', \'' + ${item.productName} + '\')'"
                        >
                          <i class="bx bx-star"></i> Đánh giá
                        </button>
                        <span
                          th:if="${item.isReviewed}"
                          class="text-success mt-2 d-inline-block"
                          style="font-size: 13px"
                        >
                          <i class="bx bx-check"></i> Đã đánh giá
                        </span>
                      </div>
                      <div class="text-right">
                        <strong
                          class="text-cyan"
                          th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                          >0 ₫</strong
                        >
                      </div>
                    </div>

                    <!-- Summary -->
                    <div class="p-4">
                      <div class="d-flex justify-between mb-2">
                        <span class="text-muted">Tạm tính:</span>
                        <span
                          th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                          >0 ₫</span
                        >
                      </div>
                      <div class="d-flex justify-between mb-2">
                        <span class="text-muted">Phí ship:</span>
                        <span
                          th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                          >0 ₫</span
                        >
                      </div>
                      <div
                        th:if="${order.discountAmount != null && order.discountAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                        class="d-flex justify-between mb-2"
                      >
                        <span class="text-muted">Giảm giá:</span>
                        <span
                          class="text-success"
                          th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                          >0 ₫</span
                        >
                      </div>
                      <div
                        class="d-flex justify-between pt-3"
                        style="border-top: 1px solid var(--border-color)"
                      >
                        <strong>Tổng cộng: </strong>
                        <strong
                          class="text-cyan"
                          style="font-size: 20px"
                          th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                          >0 ₫</strong
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Order Info -->
                <div>
                  <!-- Shipping Info -->
                  <div class="card p-4 mb-4">
                    <h4 class="mb-3">
                      <i class="bx bx-map text-primary"></i> Địa chỉ giao hàng
                    </h4>
                    <p class="mb-1">
                      <strong th:text="${order.receiverName}">Tên</strong>
                    </p>
                    <p class="mb-1 text-cyan" th:text="${order.receiverPhone}">
                      SĐT
                    </p>
                    <p
                      class="text-muted mb-0"
                      style="line-height: 1.6"
                      th:text="${order.fullAddress}"
                    >
                      Địa chỉ
                    </p>
                  </div>

                  <!-- Payment Info -->
                  <div class="card p-4 mb-4">
                    <h4 class="mb-3">
                      <i class="bx bx-credit-card text-primary"></i> Thanh toán
                    </h4>
                    <div class="d-flex justify-between mb-2">
                      <span class="text-muted">Phương thức: </span>
                      <span th:text="${order.paymentMethodDisplayName}"
                        >COD</span
                      >
                    </div>
                    <div class="d-flex justify-between">
                      <span class="text-muted">Trạng thái:</span>
                      <span th:if="${order.isPaid}" class="text-success"
                        ><i class="bx bx-check-circle"></i> Đã thanh toán</span
                      >
                      <span th:unless="${order.isPaid}" class="text-warning"
                        ><i class="bx bx-time"></i> Chưa thanh toán</span
                      >
                    </div>
                  </div>

                  <!-- Note -->
                  <div class="card p-4 mb-4" th:if="${order.note}">
                    <h4 class="mb-3">
                      <i class="bx bx-note text-primary"></i> Ghi chú
                    </h4>
                    <p class="text-muted mb-0" th:text="${order.note}">
                      Ghi chú
                    </p>
                  </div>

                  <!-- Actions -->
                  <div class="d-flex gap-3 flex-wrap">
                    <a
                      th:if="${order.status.name() == 'COMPLETED'}"
                      th:href="@{/checkout(reorder=${order.orderCode})}"
                      class="btn btn-primary"
                    >
                      <i class="bx bx-refresh"></i> Mua lại
                    </a>
                    <form
                      th:if="${order.status.name() == 'PENDING'}"
                      th:action="@{/profile/orders/{code}/cancel(code=${order.orderCode})}"
                      method="post"
                      style="display: inline"
                    >
                      <input
                        type="hidden"
                        th:name="${_csrf.parameterName}"
                        th:value="${_csrf.token}"
                      />
                      <button
                        type="button"
                        class="btn btn-outline text-danger"
                        onclick="confirmDelete('Bạn có chắc muốn hủy đơn hàng này? ', () => this.closest('form').submit())"
                      >
                        <i class="bx bx-x"></i> Hủy đơn
                      </button>
                    </form>
                    <a th:href="@{/contact}" class="btn btn-ghost">
                      <i class="bx bx-support"></i> Liên hệ hỗ trợ
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Review Modal -->
      <div class="modal-overlay" id="reviewModal">
        <div class="modal" style="max-width: 500px">
          <div class="modal-header">
            <h3 class="modal-title">Đánh giá sản phẩm</h3>
            <button class="modal-close" onclick="closeModal('reviewModal')">
              <i class="bx bx-x"></i>
            </button>
          </div>
          <form id="reviewForm" onsubmit="submitReview(event)">
            <div class="modal-body">
              <input type="hidden" id="reviewProductId" />
              <p class="text-muted mb-3" id="reviewProductName">Tên sản phẩm</p>

              <div class="form-group">
                <label class="form-label">Đánh giá của bạn</label>
                <div class="rating-input d-flex gap-2" id="ratingInput">
                  <i
                    class="bx bx-star"
                    data-rating="1"
                    onclick="setRating(1)"
                  ></i>
                  <i
                    class="bx bx-star"
                    data-rating="2"
                    onclick="setRating(2)"
                  ></i>
                  <i
                    class="bx bx-star"
                    data-rating="3"
                    onclick="setRating(3)"
                  ></i>
                  <i
                    class="bx bx-star"
                    data-rating="4"
                    onclick="setRating(4)"
                  ></i>
                  <i
                    class="bx bx-star"
                    data-rating="5"
                    onclick="setRating(5)"
                  ></i>
                </div>
                <input type="hidden" id="ratingValue" value="5" />
              </div>

              <div class="form-group">
                <label class="form-label">Tiêu đề (tùy chọn)</label>
                <input
                  type="text"
                  id="reviewTitle"
                  class="form-control"
                  placeholder="Tóm tắt đánh giá"
                />
              </div>

              <div class="form-group mb-0">
                <label class="form-label">Nội dung đánh giá</label>
                <textarea
                  id="reviewComment"
                  class="form-control"
                  rows="4"
                  required
                  placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm này... "
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-ghost"
                onclick="closeModal('reviewModal')"
              >
                Hủy
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bx bx-send"></i> Gửi đánh giá
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <th:block layout:fragment="scripts">
      <script>
        let currentRating = 5;

        function openReviewModal(productId, productName) {
          document.getElementById("reviewProductId").value = productId;
          document.getElementById("reviewProductName").textContent =
            productName;
          document.getElementById("reviewForm").reset();
          setRating(5);
          openModal("reviewModal");
        }

        function setRating(rating) {
          currentRating = rating;
          document.getElementById("ratingValue").value = rating;

          document.querySelectorAll("#ratingInput i").forEach((star, index) => {
            if (index < rating) {
              star.classList.remove("bx-star");
              star.classList.add("bxs-star");
              star.style.color = "var(--star-gold)";
            } else {
              star.classList.remove("bxs-star");
              star.classList.add("bx-star");
              star.style.color = "var(--text-muted)";
            }
          });
        }

        async function submitReview(e) {
          e.preventDefault();

          const data = {
            productId: document.getElementById("reviewProductId").value,
            rating: parseInt(document.getElementById("ratingValue").value),
            title: document.getElementById("reviewTitle").value,
            comment: document.getElementById("reviewComment").value,
            orderCode: "[[${order.orderCode}]]",
          };

          try {
            const response = await fetch("/api/reviews", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
              showToast("success", "Thành công", "Cảm ơn bạn đã đánh giá! ");
              closeModal("reviewModal");
              location.reload();
            } else {
              showToast("error", "Lỗi", result.message);
            }
          } catch (error) {
            showToast("error", "Lỗi", "Không thể gửi đánh giá");
          }
        }

        // Init rating stars
        setRating(5);
      </script>
      <style>
        #ratingInput i {
          font-size: 32px;
          cursor: pointer;
          transition: all 0.2s;
        }
        #ratingInput i:hover {
          transform: scale(1.2);
        }
        .bg-success {
          background: var(--success) !important;
        }
        .bg-muted {
          background: var(--bg-void) !important;
        }
      </style>
    </th:block>
  </body>
</html>
