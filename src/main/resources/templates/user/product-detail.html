<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/main}"
>
  <head>
    <meta charset="utf-8" />
    <title th:text="${product.name}">Chi tiết sản phẩm</title>
    <style>
      /* --- COSMIC PRODUCT DETAIL STYLE --- */
      :root {
        --bg-page: #050505;
        --bg-card: #121212;
        --text-main: #ffffff;
        --text-sub: #a1a1aa;
        --primary: #8b5cf6; /* Tím */
        --primary-hover: #7c3aed;
        --accent: #22d3ee; /* Cyan */
        --border: #27272a;
      }

      /* Layout Fix */
      .product-detail-page {
        background-color: var(--bg-page);
        color: var(--text-main);
        padding-top: 40px;
        padding-bottom: 80px;
      }

      /* Breadcrumb */
      .cosmic-breadcrumb {
        margin-bottom: 30px;
        font-size: 14px;
        color: var(--text-sub);
      }
      .cosmic-breadcrumb a {
        color: var(--text-sub);
        text-decoration: none;
        transition: 0.3s;
      }
      .cosmic-breadcrumb a:hover {
        color: var(--primary);
      }
      .cosmic-breadcrumb span {
        margin: 0 8px;
        color: #555;
      }

      /* Main Grid */
      .product-main-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 60px;
        margin-bottom: 60px;
      }

      /* --- GALLERY --- */
      .gallery-wrapper {
        position: sticky;
        top: 100px;
      }
      .main-image-box {
        width: 100%;
        aspect-ratio: 1/1;
        background: #fff;
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        position: relative;
        border: 1px solid var(--border);
      }
      .main-image-box img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        transition: transform 0.5s ease;
      }
      .main-image-box:hover img {
        transform: scale(1.05);
      }

      .thumb-list {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      .thumb-item {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        background: #fff;
        border: 2px solid transparent;
        cursor: pointer;
        padding: 5px;
        flex-shrink: 0;
        opacity: 0.6;
        transition: 0.3s;
      }
      .thumb-item.active,
      .thumb-item:hover {
        border-color: var(--primary);
        opacity: 1;
      }
      .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      /* --- INFO SECTION --- */
      .product-brand {
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 10px;
        display: block;
      }
      .product-title {
        font-size: 32px;
        font-weight: 800;
        line-height: 1.2;
        margin-bottom: 15px;
        text-transform: uppercase;
        font-family: "Orbitron", sans-serif;
      }
      .product-price-box {
        display: flex;
        align-items: baseline;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }
      .current-price {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
      }
      .old-price {
        font-size: 18px;
        color: var(--text-sub);
        text-decoration: line-through;
      }
      .discount-tag {
        background: var(--primary);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 700;
      }

      /* Variants */
      .variant-section {
        margin-bottom: 25px;
      }
      .variant-title {
        font-size: 14px;
        color: var(--text-sub);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .variant-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .color-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid var(--border);
        position: relative;
        transition: 0.2s;
      }
      .color-btn.selected {
        border-color: var(--text-main);
        box-shadow: 0 0 0 2px var(--primary);
        transform: scale(1.1);
      }
      /* Shopee-like Variant Options */
      .shopee-option {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 80px;
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-main);
        cursor: pointer;
        border-radius: 2px;
        text-align: center;
        position: relative;
        user-select: none;
        transition: all 0.2s;
        margin-right: 10px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .shopee-option:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .shopee-option.selected {
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
      }
      .shopee-option.selected::before {
        content: "";
        position: absolute;
        bottom: 0;
        right: 0;
        border-width: 0 0 15px 15px;
        border-style: solid;
        border-color: transparent transparent var(--primary) transparent;
      }
      .shopee-option.selected::after {
        content: "✓";
        position: absolute;
        bottom: -1px;
        right: 0px;
        font-size: 10px;
        color: white;
        line-height: 1;
      }
      .shopee-option.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background: #1a1a1a;
        color: #555;
        border-color: var(--border);
      }
      .shopee-option.disabled:hover {
        border-color: var(--border);
        color: #555;
      }

      /* Specific adjustments for Color Text handling if needed */
      .color-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
        border: 1px solid #555;
      }

      /* Actions */
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 40px;
      }
      .btn-main {
        width: 100%;
        padding: 16px;
        border-radius: 10px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        border: none;
        font-size: 16px;
        transition: 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .btn-add-cart {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .btn-add-cart:hover {
        background: rgba(139, 92, 246, 0.2);
      }
      .btn-buy-now {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
      }
      .btn-buy-now:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
      }

      /* --- PRODUCT CONTENT STYLES --- */
      .product-content-wrapper {
        border-top: 1px solid var(--border);
        padding-top: 40px;
      }
      .section-heading {
        color: var(--text-main);
        margin-bottom: 20px;
        text-transform: uppercase;
        font-size: 20px;
        border-left: 4px solid var(--primary);
        padding-left: 12px;
      }

      /* Description Rich Text Style (Giống Word) */
      .description-box {
        background: #18181b;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid var(--border);
        color: #e4e4e7;
        line-height: 1.8;
        font-size: 16px;
        margin-bottom: 50px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      /* Đảm bảo ảnh trong bài viết không bị tràn */
      .description-box img {
        max-width: 100%;
        height: auto !important;
        border-radius: 8px;
        margin: 20px auto;
        display: block;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .description-box h1,
      .description-box h2,
      .description-box h3 {
        color: white;
        margin-top: 25px;
        margin-bottom: 15px;
      }
      .description-box ul,
      .description-box ol {
        margin-left: 20px;
        margin-bottom: 15px;
      }

      /* Specs Cards Grid (Khôi phục giao diện Card) */
      .specs-grid-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .spec-card-item {
        background: #18181b;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: 0.3s;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .spec-card-item:hover {
        border-color: var(--primary);
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .spec-card-key {
        color: var(--text-sub);
        font-size: 13px;
        text-transform: uppercase;
        margin-bottom: 8px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .spec-card-value {
        color: white;
        font-weight: 700;
        font-size: 16px;
      }

      /* Responsive */
      @media (max-width: 992px) {
        .product-main-grid {
          grid-template-columns: 1fr;
          gap: 40px;
        }
        .gallery-wrapper {
          position: static;
        }
      }
      .color-btn.text-mode {
        width: auto !important;
        height: auto !important;
        border-radius: 8px !important;
        border: 1px solid var(--border);
        background: transparent;
        color: white;
      }
      .color-btn.text-mode.selected {
        border-color: var(--primary);
        background: rgba(139, 92, 246, 0.2);
      }
    </style>
  </head>

  <body>
    <main layout:fragment="content" class="product-detail-page">
      <div class="container">
        <nav class="cosmic-breadcrumb">
          <a th:href="@{/}">TRANG CHỦ</a>
          <span>/</span>
          <a th:href="@{/products}">SẢN PHẨM</a>
          <span th:if="${product.category}">/</span>
          <a
            th:if="${product.category}"
            th:href="@{/products(category=${product.category.slug})}"
            th:text="${#strings.toUpperCase(product.category.name)}"
            >DANH MỤC</a
          >
          <span>/</span>
          <span
            class="text-white"
            th:text="${#strings.toUpperCase(product.name)}"
            >TÊN SP</span
          >
        </nav>

        <div class="product-main-grid">
          <div class="gallery-wrapper">
            <div class="main-image-box">
              <img
                id="mainProductImage"
                th:src="@{${(product.images != null && !product.images.isEmpty()) ? product.images[0].imageUrl : '/images/no-image.png'}}"
                th:alt="${product.name}"
              />

              <div
                style="
                  position: absolute;
                  top: 15px;
                  left: 15px;
                  display: flex;
                  gap: 8px;
                "
              >
                <span th:if="${product.isOnSale}" class="discount-tag"
                  >-[[${product.discountPercent}]]%</span
                >
                <span
                  th:if="${product.isNew}"
                  class="discount-tag"
                  style="background: var(--accent)"
                  >NEW</span
                >
              </div>
            </div>

            <div
              class="thumb-list"
              th:if="${product.images != null && product.images.size() > 1}"
            >
              <div
                th:each="image, stat : ${product.images}"
                class="thumb-item"
                th:classappend="${stat.first} ? 'active' : ''"
                th:data-image="${image.imageUrl}"
                onclick="changeMainImage(this)"
              >
                <img th:src="@{${image.imageUrl}}" th:alt="${product.name}" />
              </div>
            </div>
          </div>

          <div class="product-info">
            <a
              th:if="${product.brand}"
              th:href="@{/products(brand=${product.brand.slug})}"
              class="product-brand"
              th:text="${product.brand.name}"
              >BRAND</a
            >
            <h1 class="product-title" th:text="${product.name}">
              TÊN SẢN PHẨM
            </h1>

            <div class="product-price-box">
              <span
                class="current-price"
                th:text="${#numbers.formatDecimal(product.isOnSale ? product.salePrice : product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
              >
                0 ₫
              </span>
              <span
                th:if="${product.isOnSale}"
                class="old-price"
                th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
              >
                0 ₫
              </span>
            </div>

            <!-- VARIANT SELECTION (Rendered by JS) -->
            <div
              id="variant-area"
              class="product-variants"
              th:if="${product.variants != null && !product.variants.isEmpty()}"
            >
              <!-- Color Options -->
              <div
                id="color-section"
                class="variant-section"
                style="display: none"
              >
                <div class="variant-title">
                  MÀU SẮC: <span id="lbl-color" class="text-white"></span>
                </div>
                <div class="variant-grid" id="color-container"></div>
              </div>

              <!-- Size Options -->
              <div
                id="size-section"
                class="variant-section"
                style="display: none"
              >
                <div class="variant-title">
                  KÍCH THƯỚC: <span id="lbl-size" class="text-white"></span>
                </div>
                <div class="variant-grid" id="size-container"></div>
              </div>
            </div>

            <div class="variant-section">
              <div class="variant-title">SỐ LƯỢNG</div>
              <div
                style="
                  display: inline-flex;
                  border: 1px solid var(--border);
                  border-radius: 8px;
                  overflow: hidden;
                "
              >
                <button
                  class="quantity-btn"
                  onclick="changeQuantity(-1)"
                  style="
                    width: 40px;
                    height: 40px;
                    background: #18181b;
                    color: white;
                    border: none;
                    cursor: pointer;
                  "
                >
                  -
                </button>
                <input
                  type="number"
                  id="quantity"
                  value="1"
                  min="1"
                  style="
                    width: 50px;
                    text-align: center;
                    background: #18181b;
                    color: white;
                    border: none;
                    -moz-appearance: textfield;
                  "
                />
                <button
                  class="quantity-btn"
                  onclick="changeQuantity(1)"
                  style="
                    width: 40px;
                    height: 40px;
                    background: #18181b;
                    color: white;
                    border: none;
                    cursor: pointer;
                  "
                >
                  +
                </button>
              </div>
              <span class="text-sub ms-3" style="font-size: 13px">
                Còn lại:
                <span id="stockCount" th:text="${product.quantity}">0</span> sản
                phẩm
              </span>
            </div>

            <div class="action-buttons">
              <button
                id="addToCartBtn"
                class="btn-main btn-add-cart"
                th:disabled="${!product.isInStock}"
                th:data-product-id="${product.id}"
              >
                <i class="bx bxs-cart-add"></i>
                <span
                  th:text="${product.isInStock} ? 'THÊM VÀO GIỎ HÀNG' : 'TẠM HẾT HÀNG'"
                  >THÊM VÀO GIỎ HÀNG</span
                >
              </button>

              <button
                id="buyNowBtn"
                class="btn-main btn-buy-now"
                th:if="${product.isInStock}"
              >
                MUA NGAY
              </button>
            </div>

            <div
              style="
                margin-top: 30px;
                font-size: 14px;
                line-height: 1.6;
                color: var(--text-sub);
              "
            >
              <p th:text="${product.shortDescription}">Mô tả ngắn...</p>
            </div>
          </div>
        </div>

        <div class="product-content-wrapper">
          <h3 class="section-heading">
            <i class="bx bx-list-ul"></i> Thông số kỹ thuật
          </h3>

          <div
            class="specs-grid-cards"
            th:if="${product.specifications != null && !product.specifications.isEmpty()}"
          >
            <th:block
              th:each="line : ${#strings.arraySplit(product.specifications, '
')}"
            >
              <div
                class="spec-card-item"
                th:if="${#strings.contains(line, ':')}"
              >
                <div
                  class="spec-card-key"
                  th:text="${#strings.arraySplit(line, ':')[0]}"
                >
                  Label
                </div>
                <div
                  class="spec-card-value"
                  th:text="${#strings.substringAfter(line, ':')}"
                >
                  Value
                </div>
              </div>
            </th:block>
          </div>
          <div
            th:unless="${product.specifications}"
            class="text-muted fst-italic mb-5"
          >
            Chưa có thông số kỹ thuật.
          </div>

          <h3 class="section-heading">
            <i class="bx bx-detail"></i> Chi tiết sản phẩm
          </h3>

          <div class="description-box">
            <div
              th:if="${product.description}"
              th:utext="${product.description}"
            ></div>

            <p th:unless="${product.description}" class="text-muted fst-italic">
              Thông tin chi tiết đang cập nhật...
            </p>
          </div>
        </div>
      </div>
    </main>

    <th:block layout:fragment="scripts">
      <script th:inline="javascript">
        const productId = /*[[${product.id}]]*/ 0;

        // Base Info
        const basePrice = /*[[${product.isOnSale ? product.salePrice : product.price}]]*/ 0;
        const baseStock = /*[[${product.quantity}]]*/ 0;
        const formatPrice = (price) =>
          new Intl.NumberFormat("vi-VN").format(price) + " ₫";

        // Variants Data
        const allVariants = /*[[${product.variants}]]*/ [];

        // State
        let state = {
          color: null,
          size: null,
          variantId: null,
        };

        // --- INIT ---
        document.addEventListener("DOMContentLoaded", () => {
          renderVariantsUI();
        });

        // --- RENDER LOGIC ---
        function renderVariantsUI() {
          if (!allVariants || allVariants.length === 0) return;

          // 1. Get Distinct Colors & Sizes
          const colors = [
            ...new Set(allVariants.map((v) => v.color).filter((c) => c)),
          ];
          const sizes = [
            ...new Set(allVariants.map((v) => v.size).filter((s) => s)),
          ];

          const colorContainer = document.getElementById("color-container");
          const sizeContainer = document.getElementById("size-container");
          const colorSection = document.getElementById("color-section");
          const sizeSection = document.getElementById("size-section");

          // 2. Render Colors
          if (colors.length > 0) {
            colorSection.style.display = "block";
            colorContainer.innerHTML = "";
            colors.forEach((c) => {
              const btn = document.createElement("div");
              btn.className = `shopee-option ${state.color === c ? "selected" : ""}`;
              // Check availability based on current Size selection
              if (state.size && !checkAvailability(c, state.size)) {
                btn.classList.add("disabled");
              }

              btn.innerHTML = c;
              btn.onclick = () => handleColorClick(c);
              colorContainer.appendChild(btn);
            });
          }

          // 3. Render Sizes
          if (sizes.length > 0) {
            sizeSection.style.display = "block";
            sizeContainer.innerHTML = "";
            sizes.forEach((s) => {
              const btn = document.createElement("div");
              btn.className = `shopee-option ${state.size === s ? "selected" : ""}`;
              // Check availability based on current Color selection
              if (state.color && !checkAvailability(state.color, s)) {
                btn.classList.add("disabled");
              }

              btn.innerHTML = s;
              btn.onclick = () => handleSizeClick(s);
              sizeContainer.appendChild(btn);
            });
          }

          // 4. Update Result
          updateProductInfo();
        }

        // --- HANDLERS ---
        function handleColorClick(color) {
          // Toggle Logic
          if (state.color === color) {
            state.color = null; // Deselect
          } else {
            state.color = color;
            // If current size is invalid with new color, reset size?
            // Creating a better UX: Reset size if combination doesn't exist.
            if (state.size && !checkAvailability(color, state.size)) {
              state.size = null;
            }
          }
          renderVariantsUI();
        }

        function handleSizeClick(size) {
          if (state.size === size) {
            state.size = null;
          } else {
            state.size = size;
            if (state.color && !checkAvailability(state.color, size)) {
              state.color = null;
            }
          }
          renderVariantsUI();
        }

        // --- HELPERS ---
        function checkAvailability(color, size) {
          return allVariants.some(
            (v) => (!color || v.color === color) && (!size || v.size === size),
          );
        }

        function updateProductInfo() {
          // Find logic
          let matchedVariant = null;

          // Strict matching: Only if both selected (or if product only has one attribute)
          const hasColors = allVariants.some((v) => v.color);
          const hasSizes = allVariants.some((v) => v.size);

          if ((!hasColors || state.color) && (!hasSizes || state.size)) {
            matchedVariant = allVariants.find(
              (v) =>
                (!hasColors || v.color === state.color) &&
                (!hasSizes || v.size === state.size),
            );
          }

          // Update UI Labels using state
          document.getElementById("lbl-color").textContent = state.color || "";
          document.getElementById("lbl-size").textContent = state.size || "";

          const priceEl = document.querySelector(".current-price");
          const stockEl = document.getElementById("stockCount");
          const mainImg = document.getElementById("mainProductImage");

          if (matchedVariant) {
            state.variantId = matchedVariant.id;

            // Update Price
            priceEl.textContent = formatPrice(matchedVariant.finalPrice);

            // Update Stock
            stockEl.textContent = matchedVariant.quantity;
            document.getElementById("quantity").max = matchedVariant.quantity;
            document.getElementById("quantity").value = 1; // Reset qty

            // Update Image
            if (matchedVariant.imageUrl && matchedVariant.imageUrl !== "null") {
              // Check if it's array string
              let url = matchedVariant.imageUrl;
              if (url.startsWith("[")) {
                url = url
                  .replace("[", "")
                  .replace("]", "")
                  .split(",")[0]
                  .trim();
              }
              if (mainImg.src !== url) {
                mainImg.style.opacity = 0.5;
                setTimeout(() => {
                  mainImg.src = url;
                  mainImg.style.opacity = 1;
                }, 200);
              }
            }

            document.getElementById("addToCartBtn").disabled =
              matchedVariant.quantity <= 0;
          } else {
            // Reset to Base
            state.variantId = null;
            priceEl.textContent = formatPrice(basePrice);
            stockEl.textContent = baseStock;
            document.getElementById("quantity").max = baseStock;

            // Disable Add to Cart if we require selection but none selected?
            // Actually usually if "variant selection required" we disable cart.
            // But here let's assume if user hasn't selected, they add "base product"?
            // Usually not. If variants exist, you MUST select.
            // The check `(!hasColors || state.color) ...` helps.

            // If we are pending selection (Variants exist but not fully picked)
            if ((hasColors && !state.color) || (hasSizes && !state.size)) {
              // Maybe keep button enabled but it will fail validation?
              // Or disable it.
              // Let's disable it visually to prompt user.
              // But existing code didn't force it explicitly in UI state (just backend validation).
              // Use logic: if variants exist, selectedVariantId is null -> User can't buy.
              // Let's keep button enabled but maybe Toast error?
              // Just set selectedVariantId = null.
            }
          }
        }

        // Số lượng
        function changeQuantity(delta) {
          const input = document.getElementById("quantity");
          let val = parseInt(input.value) || 1;
          const max = parseInt(input.max) || 999;
          val = Math.max(1, Math.min(val + delta, max));
          input.value = val;
        }

        // Đổi ảnh chính
        function changeMainImage(thumb) {
          const imageUrl = thumb.getAttribute("data-image");
          const mainImg = document.getElementById("mainProductImage");

          // Hiệu ứng fade nhẹ
          mainImg.style.opacity = 0;
          setTimeout(() => {
            mainImg.src = imageUrl;
            mainImg.style.opacity = 1;
          }, 200);

          // Update active class
          document
            .querySelectorAll(".thumb-item")
            .forEach((t) => t.classList.remove("active"));
          thumb.classList.add("active");
        }

        // --- OLD FUNCTIONS REPLACEMENT END ---
        // We merged selectVariant logic into handleColor/SizeClick.
        // We removed selectVariant function.

        let selectedVariantId = null; // Compatibility proxy if needed, but we use state.variantId

        // Replace addToCart listener to use state.variantId
        document
          .getElementById("addToCartBtn")
          .addEventListener("click", function () {
            if (allVariants.length > 0 && !state.variantId) {
              showToast("error", "Lỗi", "Vui lòng chọn phân loại hàng");
              return;
            }
            const qty = parseInt(document.getElementById("quantity").value);
            addToCart(productId, state.variantId, qty);
          });

        // Mua ngay
        document
          .getElementById("buyNowBtn")
          ?.addEventListener("click", function () {
            const qty = parseInt(document.getElementById("quantity").value);
            addToCart(productId, selectedVariantId, qty, true);
          });

        // Hàm gọi API (Giữ nguyên logic cũ của bạn)
        async function addToCart(
          productId,
          variantId,
          quantity,
          redirect = false,
        ) {
          try {
            const csrfTokenInput = document.querySelector(
              'input[name="_csrf"]',
            );
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : "";

            const response = await fetch("/api/cart/items", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": csrfToken,
              },
              body: JSON.stringify({ productId, variantId, quantity }),
            });
            const data = await response.json();

            if (response.ok && data.success) {
              showToast("success", "Thành công", "Đã thêm vào giỏ hàng");
              if (redirect) window.location.href = "/cart";
              else {
                await refreshCartHeader();
              }
            } else {
              showToast("error", "Lỗi", data.message || "Không thể thêm");
            }
          } catch (e) {
            console.error(e);
            showToast("error", "Lỗi", "Có lỗi xảy ra");
          }
        }
        async function refreshCartHeader() {
          try {
            const response = await fetch("/cart/fragment"); // Gọi endpoint tạo ở Bước 2
            if (response.ok) {
              const html = await response.text();
              // Tìm và thay thế cục giỏ hàng cũ bằng cục mới
              const oldCartPanel = document.getElementById("headerCartPanel");
              if (oldCartPanel) {
                oldCartPanel.outerHTML = html;
              }
            }
          } catch (e) {
            console.error("Lỗi cập nhật giỏ hàng:", e);
          }
        }
      </script>
    </th:block>
  </body>
</html>
