<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/main}"
>
  <head>
    <title>Thanh toán</title>
    <style>
      .order-item {
        position: relative;
      }
      .order-item__image {
        position: relative;
      }
      @media (max-width: 992px) {
        .checkout-layout {
          grid-template-columns: 1fr !important;
        }
        .checkout-right {
          order: -1;
        }
      }
      /* Loader spinner icon */
      .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
      }
    </style>
  </head>

  <body>
    <main layout:fragment="content">
      <div class="checkout-page">
        <div class="container">
          <nav class="breadcrumb">
            <div class="breadcrumb__item">
              <a th:href="@{/}"><i class="bx bx-home"></i> Trang chủ</a>
            </div>
            <span class="breadcrumb__separator"
              ><i class="bx bx-chevron-right"></i
            ></span>
            <div class="breadcrumb__item">
              <a th:href="@{/cart}">Giỏ hàng</a>
            </div>
            <span class="breadcrumb__separator"
              ><i class="bx bx-chevron-right"></i
            ></span>
            <div class="breadcrumb__item">Thanh toán</div>
          </nav>

          <h1 class="section-title mb-4">Thanh toán</h1>

          <form
            th:action="@{/checkout}"
            method="post"
            th:object="${checkoutRequest}"
            id="checkoutForm"
          >
            <div
              th:if="${#fields.hasErrors('*')}"
              class="alert alert-danger"
              style="
                background: #ffebee;
                color: #c62828;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                border: 1px solid #ef9a9a;
              "
            >
              <h4 style="margin: 0 0 10px 0; font-size: 16px">
                <i class="bx bx-error-circle"></i> Lỗi Validation:
              </h4>
              <ul style="margin: 0; padding-left: 20px">
                <li
                  th:each="err : ${#fields.errors('*')}"
                  th:text="${err}"
                ></li>
              </ul>
            </div>
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />

            <div
              class="checkout-layout"
              style="display: grid; grid-template-columns: 1fr 420px; gap: 30px"
            >
              <div class="checkout-left">
                <div class="checkout-section">
                  <h3 class="checkout-section__title">
                    <i class="bx bx-map"></i> Địa chỉ giao hàng
                  </h3>

                  <div
                    th:if="${addresses != null && !addresses.isEmpty()}"
                    class="address-list"
                  >
                    <div
                      th:each="addr : ${addresses}"
                      class="address-card"
                      th:classappend="${addr.isDefault} ? 'selected' : ''"
                      th:data-address-id="${addr.id}"
                      onclick="selectAddress(this)"
                    >
                      <input
                        type="radio"
                        name="addressId"
                        th:value="${addr.id}"
                        class="address-card__radio"
                        th:checked="${addr.isDefault}"
                      />
                      <div
                        class="address-card__name"
                        th:text="${addr.receiverName}"
                      >
                        Tên
                      </div>
                      <div class="address-card__phone" th:text="${addr.phone}">
                        SĐT
                      </div>
                      <div
                        class="address-card__detail"
                        th:text="${addr.fullAddress}"
                      >
                        Địa chỉ
                      </div>
                      <span
                        th:if="${addr.isDefault}"
                        class="address-card__default-badge"
                        >Mặc định</span
                      >
                    </div>

                    <div
                      class="address-card"
                      onclick="toggleNewAddressForm()"
                      style="
                        justify-content: center;
                        align-items: center;
                        min-height: 150px;
                        cursor: pointer;
                      "
                    >
                      <div class="text-center">
                        <i
                          class="bx bx-plus"
                          style="font-size: 32px; color: var(--primary)"
                        ></i>
                        <p class="text-muted mt-2">Thêm địa chỉ mới</p>
                      </div>
                    </div>
                  </div>

                  <div
                    id="newAddressForm"
                    th:classappend="${addresses == null || addresses.isEmpty()} ? '' : 'd-none'"
                  >
                    <div
                      class="row"
                      style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                      "
                    >
                      <div class="form-group">
                        <label class="form-label"
                          >Họ tên người nhận
                          <span class="text-danger">*</span></label
                        >
                        <input
                          type="text"
                          th:field="*{receiverName}"
                          class="form-control"
                          placeholder="Nhập họ tên"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >Số điện thoại
                          <span class="text-danger">*</span></label
                        >
                        <input
                          type="tel"
                          th:field="*{receiverPhone}"
                          class="form-control"
                          placeholder="Nhập số điện thoại"
                        />
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input
                        type="email"
                        th:field="*{receiverEmail}"
                        class="form-control"
                        placeholder="Nhập email (tùy chọn)"
                      />
                    </div>

                    <div
                      class="row"
                      style="
                        display: grid;
                        grid-template-columns: 1fr 1fr 1fr;
                        gap: 20px;
                      "
                    >
                      <div class="form-group">
                        <label class="form-label"
                          >Tỉnh/Thành phố
                          <span class="text-danger">*</span></label
                        >
                        <select
                          th:field="*{city}"
                          class="form-control form-select"
                          id="citySelect"
                        >
                          <option value="" selected>Chọn Tỉnh/TP</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >Quận/Huyện <span class="text-danger">*</span></label
                        >
                        <select
                          th:field="*{district}"
                          class="form-control form-select"
                          id="districtSelect"
                        >
                          <option value="" selected>Chọn Quận/Huyện</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label">Phường/Xã</label>
                        <select
                          th:field="*{ward}"
                          class="form-control form-select"
                          id="wardSelect"
                        >
                          <option value="" selected>Chọn Phường/Xã</option>
                        </select>
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label"
                        >Địa chỉ chi tiết
                        <span class="text-danger">*</span></label
                      >
                      <input
                        type="text"
                        th:field="*{shippingAddress}"
                        class="form-control"
                        placeholder="Số nhà, tên đường..."
                      />
                    </div>
                  </div>
                </div>

                <div class="checkout-section">
                  <h3 class="checkout-section__title">
                    <i class="bx bx-credit-card"></i> Phương thức thanh toán
                  </h3>
                  <div class="payment-methods">
                    <label class="payment-method selected" data-method="COD">
                      <input
                        type="radio"
                        th:field="*{paymentMethod}"
                        value="COD"
                        checked
                        style="display: none"
                      />
                      <div class="payment-method__icon">
                        <i class="bx bx-money"></i>
                      </div>
                      <div class="payment-method__info">
                        <div class="payment-method__name">
                          Thanh toán khi nhận hàng (COD)
                        </div>
                        <div class="payment-method__desc">
                          Thanh toán bằng tiền mặt khi nhận hàng
                        </div>
                      </div>
                      <i
                        class="bx bx-check-circle text-success"
                        style="font-size: 24px"
                      ></i>
                    </label>

                    <label class="payment-method" data-method="VNPAY">
                      <input
                        type="radio"
                        th:field="*{paymentMethod}"
                        value="VNPAY"
                        style="display: none"
                      />
                      <div class="payment-method__icon">
                        <img
                          th:src="@{/images/payments/vnpay.svg}"
                          alt="VNPay"
                          style="width: 40px"
                        />
                      </div>
                      <div class="payment-method__info">
                        <div class="payment-method__name">VNPay</div>
                        <div class="payment-method__desc">
                          Thanh toán qua VNPay QR, ATM, Visa, Master
                        </div>
                      </div>
                      <i
                        class="bx bx-check-circle text-success"
                        style="font-size: 24px; opacity: 0"
                      ></i>
                    </label>
                  </div>
                </div>

                <div class="checkout-section">
                  <h3 class="checkout-section__title">
                    <i class="bx bx-note"></i> Ghi chú đơn hàng
                  </h3>
                  <div class="form-group mb-0">
                    <textarea
                      th:field="*{note}"
                      class="form-control"
                      rows="3"
                      placeholder="Ghi chú về đơn hàng..."
                    ></textarea>
                  </div>
                </div>
              </div>

              <div class="checkout-right">
                <div class="cart-summary" style="position: sticky; top: 100px">
                  <h3 class="cart-summary__title">
                    Đơn hàng của bạn
                    <span
                      class="text-muted"
                      style="font-size: 14px; font-weight: normal"
                    >
                      (<span th:text="${cart.totalItems}">0</span> sản phẩm)
                    </span>
                  </h3>

                  <div
                    class="order-items"
                    style="
                      max-height: 300px;
                      overflow-y: auto;
                      margin-bottom: 20px;
                    "
                  >
                    <div
                      th:each="item : ${cart.items}"
                      th:if="${item.isSelected}"
                      class="order-item"
                    >
                      <div class="order-item__image">
                        <img
                          th:src="${item.productImage}"
                          th:alt="${item.productName}"
                        />
                        <span
                          class="order-item__qty"
                          style="
                            position: absolute;
                            top: -8px;
                            right: -8px;
                            width: 24px;
                            height: 24px;
                            background: var(--primary);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: 700;
                            color: #fff;
                          "
                          th:text="${item.quantity}"
                          >1</span
                        >
                      </div>
                      <div class="order-item__info">
                        <div
                          class="order-item__name"
                          th:text="${item.productName}"
                        >
                          Sản phẩm
                        </div>
                        <div
                          th:if="${item.variantName}"
                          class="order-item__variant"
                          th:text="${item.variantName}"
                        >
                          Variant
                        </div>
                      </div>
                      <div
                        class="order-item__price"
                        th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                      >
                        0 ₫
                      </div>
                    </div>
                  </div>

                  <div class="voucher-section mb-4">
                    <div class="voucher-form">
                      <input
                        type="text"
                        th:field="*{voucherCode}"
                        class="form-control"
                        placeholder="Nhập mã giảm giá"
                        id="voucherInput"
                      />
                      <button
                        type="button"
                        class="btn btn-dark"
                        onclick="applyVoucher()"
                      >
                        Áp dụng
                      </button>
                    </div>
                    <div
                      id="voucherMessage"
                      class="mt-2"
                      style="font-size: 13px"
                    ></div>
                  </div>

                  <div class="cart-summary__row">
                    <span class="cart-summary__label">Tạm tính</span>
                    <span
                      class="cart-summary__value"
                      id="subtotalValue"
                      th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                      >0 ₫</span
                    >
                  </div>

                  <div class="cart-summary__row">
                    <span class="cart-summary__label">Phí vận chuyển</span>
                    <span class="cart-summary__value" id="shippingValue">
                      <span
                        th:if="${shippingFee.compareTo(T(java.math.BigDecimal).ZERO) == 0}"
                        class="text-success"
                        >Miễn phí</span
                      >
                      <span
                        th:unless="${shippingFee.compareTo(T(java.math.BigDecimal).ZERO) == 0}"
                        th:text="${#numbers.formatDecimal(shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                        >30,000 ₫</span
                      >
                    </span>
                  </div>

                  <div
                    class="cart-summary__row"
                    id="discountRow"
                    style="display: none"
                  >
                    <span class="cart-summary__label">Giảm giá</span>
                    <span
                      class="cart-summary__value text-success"
                      id="discountValue"
                      >-0 ₫</span
                    >
                  </div>

                  <div class="cart-summary__total">
                    <span class="cart-summary__total-label">Tổng cộng</span>
                    <span
                      class="cart-summary__total-value"
                      id="totalValue"
                      th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                      >0 ₫</span
                    >
                  </div>

                  <button
                    type="submit"
                    class="btn btn-primary btn-lg btn-block mt-4"
                    id="placeOrderBtn"
                  >
                    <i class="bx bx-check-circle"></i> Đặt hàng
                  </button>

                  <p
                    class="text-center text-muted mt-3"
                    style="font-size: 12px"
                  >
                    Bằng việc đặt hàng, bạn đồng ý với
                    <a th:href="@{/policy/terms}" class="text-cyan"
                      >Điều khoản sử dụng</a
                    >
                  </p>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </main>

    <th:block layout:fragment="scripts">
      <script>
        var citis = document.getElementById("citySelect");
        var districts = document.getElementById("districtSelect");
        var wards = document.getElementById("wardSelect");

        // Biến lưu trữ toàn bộ data tỉnh thành
        var dataLocation = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Gọi API từ nguồn GitHub (Ổn định, không lo chết API hay lỗi CORS)
            axios.get("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json")
                .then(function(result) {
                    dataLocation = result.data; // Lưu dữ liệu vào biến toàn cục
                    renderCity(dataLocation);
                })
                .catch(function(error) {
                    console.error('Lỗi tải dữ liệu hành chính:', error);
                    showToast('error', 'Lỗi', 'Không thể tải danh sách tỉnh thành');
                });
        });

        // Hàm render Tỉnh/Thành
        function renderCity(data) {
            for (const x of data) {
                // Lưu Name vào value luôn để gửi về server cho tiện (khỏi cần swap ID -> Name)
                citis.options[citis.options.length] = new Option(x.Name, x.Name);
                // Lưu thêm ID vào attribute để tí còn tìm Quận/Huyện
                citis.options[citis.options.length - 1].setAttribute('data-id', x.Id);
            }

            // Khi chọn Tỉnh
            citis.onchange = function () {
                districts.length = 1; // Reset Quận
                wards.length = 1;     // Reset Phường
                if(this.value !== ""){
                    // Tìm ID của tỉnh vừa chọn
                    const selectedOption = this.options[this.selectedIndex];
                    const idTinh = selectedOption.getAttribute('data-id');

                    // Lọc lấy dữ liệu Tỉnh tương ứng
                    const result = dataLocation.filter(n => n.Id === idTinh);

                    // Render Quận/Huyện
                    for (const k of result[0].Districts) {
                        districts.options[districts.options.length] = new Option(k.Name, k.Name);
                        districts.options[districts.options.length - 1].setAttribute('data-id', k.Id);
                    }
                }
            };

            // Khi chọn Quận
            districts.onchange = function () {
                wards.length = 1; // Reset Phường
                const dataCity = dataLocation.filter((n) => n.Id === citis.options[citis.selectedIndex].getAttribute('data-id'));

                if (this.value !== "") {
                    // Tìm ID quận vừa chọn
                    const selectedOption = this.options[this.selectedIndex];
                    const idQuan = selectedOption.getAttribute('data-id');

                    const dataWards = dataCity[0].Districts.filter(n => n.Id === idQuan)[0].Wards;

                    for (const w of dataWards) {
                        wards.options[wards.options.length] = new Option(w.Name, w.Name);
                    }
                }
            };
        }

        // --- CÁC LOGIC KHÁC GIỮ NGUYÊN ---

        // 1. Logic chọn địa chỉ có sẵn
        function selectAddress(card) {
            document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            const radio = card.querySelector('input[type="radio"]');
            if(radio) radio.checked = true;

            const form = document.getElementById('newAddressForm');
            if(form) form.classList.add('d-none');
            setFormRequired(false);
        }

        function toggleNewAddressForm() {
            const form = document.getElementById('newAddressForm');
            form.classList.toggle('d-none');
            if (!form.classList.contains('d-none')) {
                document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
                document.querySelectorAll('.address-card input[type="radio"]').forEach(r => r.checked = false);
                setFormRequired(true);
            } else {
                setFormRequired(false);
            }
        }

        function setFormRequired(isRequired) {
            const inputs = document.querySelectorAll('#newAddressForm input, #newAddressForm select');
            inputs.forEach(input => {
                if(input.name !== 'receiverEmail') {
                    if(isRequired) input.setAttribute('required', '');
                    else input.removeAttribute('required');
                }
            });
        }

        // 2. Logic Submit Form
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
        });

        // 3. Logic chọn thanh toán & Voucher (Giữ nguyên)
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(m => {
                    m.classList.remove('selected');
                    m.querySelector('.bx-check-circle').style.opacity = '0';
                });
                this.classList.add('selected');
                this.querySelector('.bx-check-circle').style.opacity = '1';
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
        }

        async function applyVoucher() {
            const code = document.getElementById('voucherInput').value.trim();
            if (!code) {
                showToast('warning', 'Cảnh báo', 'Vui lòng nhập mã giảm giá');
                return;
            }

            const messageEl = document.getElementById('voucherMessage');
            messageEl.innerHTML = '<span class="text-muted"><i class="bx bx-loader-alt bx-spin"></i> Đang kiểm tra...</span>';

            try {
                const subtotal = [[${subtotal}]];
                const csrfToken = document.querySelector('input[name="_csrf"]').value;

                // FIX: orderAmount must be a query parameter, not in body
                const response = await fetch(`/api/vouchers/check?orderAmount=${subtotal}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();

                if (data.success) {
                    messageEl.innerHTML = `<span class="text-success"><i class='bx bx-check'></i> ${data.message}</span>`;
                    document.getElementById('discountRow').style.display = 'flex';
                    document.getElementById('discountValue').textContent = '-' + formatCurrency(data.data.discountAmount);
                    document.getElementById('totalValue').textContent = formatCurrency(data.data.finalAmount);
                    showToast('success', 'Thành công', 'Áp dụng mã giảm giá thành công');
                } else {
                    messageEl.innerHTML = `<span class="text-danger"><i class='bx bx-x'></i> ${data.message}</span>`;
                    showToast('error', 'Lỗi', data.message || 'Mã voucher không hợp lệ');
                }
            } catch (error) {
                console.error('Voucher check error:', error);
                messageEl.innerHTML = `<span class="text-danger"><i class='bx bx-x'></i> Đã xảy ra lỗi hệ thống. Vui lòng thử lại sau.</span>`;
                showToast('error', 'Lỗi', 'Không thể kiểm tra mã giảm giá');
            }
        }
      </script>

      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"
      ></script>
    </th:block>
  </body>
</html>
